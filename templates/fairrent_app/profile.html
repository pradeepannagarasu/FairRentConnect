{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Roomto.Live Dashboard</title>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <!-- Tailwind CSS for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font for a clean, modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- Root Variables for Refined Professional Theme (Reverted to original blues) --- */
        :root {
            --primary-blue: #2563eb; /* Stronger, more vibrant blue */
            --primary-dark-blue: #1d4ed8; /* Darker primary for accents */
            --secondary-gray: #f3f4f6; /* Very light gray for backgrounds */
            --text-dark: #111827; /* Near black for main text */
            --text-medium: #4b5563; /* Medium gray for secondary text */
            --text-light: #6b7280; /* Lighter gray for subtle text */
            --bg-page: #f9fafb; /* Overall page background */
            --bg-card: #ffffff; /* Pure white for cards */
            --border-subtle: #e5e7eb; /* Light border color */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition-ease: all 0.2s ease-in-out;

            /* Custom colors for swipe buttons */
            --reject-red: #ef4444;
            --reject-dark-red: #dc2626;
            --like-green: #22c55e;
            --like-dark-green: #16a34a;

            /* AI Demo Badge Color */
            --accent-mint: #d1fae5; /* A light mint green */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-page);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            overflow-x: hidden; /* Prevent horizontal scroll issues */
        }

        /* --- Main Content Styles (Adjusted for No Sidebar) --- */
        .main-content {
            padding: 2.5rem 3rem; /* Generous padding on all sides */
            min-height: 100vh;
            width: 100%; /* Ensure it takes full width */
            box-sizing: border-box; /* Include padding in width calculation */
        }

        /* Top Header Styling */
        header {
            background-color: var(--bg-card);
            border-radius: 1.25rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-subtle);
            padding: 1rem 2rem; /* Adjusted padding */
            margin-bottom: 2.5rem; /* More space below header */
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
        }

        header .logo-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.8rem; /* Slightly smaller for header */
            font-weight: 900;
            letter-spacing: -0.5px;
            color: var(--text-dark);
            margin-right: 1rem; /* Space before nav on desktop */
        }

        header nav {
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap */
            gap: 0.75rem; /* Space between buttons */
            margin-top: 0; /* No top margin on desktop */
        }

        .dashboard-header {
            font-size: 3rem; /* Larger, more prominent heading */
            font-weight: 900;
            margin-bottom: 1.5rem; /* Adjust spacing */
            letter-spacing: -1px; /* Tighter for modern look */
            color: var(--text-dark);
            animation: slide-in 1s cubic-bezier(.45,1.6,.8,1.2) .2s both;
        }
        .dashboard-header + p { /* Description paragraph below header */
            font-size: 1.1rem;
            color: var(--text-medium);
            margin-bottom: 2.5rem; /* More space below description */
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Larger min-width for cards */
            gap: 2rem; /* Increased gap for more breathing room */
        }

        .dashboard-card {
            background-color: var(--bg-card);
            border-radius: 1.25rem; /* Even more rounded corners */
            box-shadow: var(--shadow-md);
            padding: 2rem; /* Generous padding */
            transition: var(--transition-ease);
            position: relative;
            overflow: hidden;
            animation: fade-up 0.7s cubic-bezier(.45,1.6,.8,1.2) both;
            border: 1px solid var(--border-subtle); /* Subtle border */
        }

        .dashboard-card:hover {
            box-shadow: var(--shadow-lg); /* More pronounced lift */
            transform: translateY(-7px) scale(1.01); /* Deeper lift and slight scale */
        }

        .dashboard-card .card-title {
            font-size: 1.35rem; /* Larger title */
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary-blue); /* Use primary blue */
            display: flex;
            align-items: center;
            gap: 0.75rem; /* More space */
        }
        .dashboard-card .card-title i {
            color: var(--primary-dark-blue); /* Use darker blue for icons */
        }

        .dashboard-card .card-value {
            font-size: 3rem; /* Much larger value */
            font-weight: 900;
            margin-bottom: 0.4rem;
            color: var(--text-dark);
            letter-spacing: -0.5px;
        }

        .dashboard-card .card-desc {
            color: var(--text-light);
            font-size: 0.95rem; /* Slightly larger description text */
        }

        /* --- Animations --- */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fade-up {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes slide-in {
            0% { opacity: 0; transform: translateX(-20px); }
            100% { opacity: 1; transform: translateX(0); }
        }

        /* NEW: Swipe animations */
        .roommate-match-card.swiping-left {
            animation: swipe-left 0.5s forwards;
        }
        .roommate-match-card.swiping-right {
            animation: swipe-right 0.5s forwards;
        }

        @keyframes swipe-left {
            from { transform: translateX(-50%) translateY(var(--card-offset-y)) rotate(var(--card-rotate-z)); opacity: 1; }
            to { transform: translateX(-150%) translateY(var(--card-offset-y)) rotate(calc(var(--card-rotate-z) - 30deg)); opacity: 0; }
        }
        @keyframes swipe-right {
            from { transform: translateX(-50%) translateY(var(--card-offset-y)) rotate(var(--card-rotate-z)); opacity: 1; }
            to { transform: translateX(50%) translateY(var(--card-offset-y)) rotate(calc(var(--card-rotate-z) + 30deg)); opacity: 0; }
        }

        /* --- Responsive Styles --- */
        @media (max-width: 1200px) {
            .main-content { padding: 2rem 2.5rem; } /* Adjusted padding */
            .dashboard-header { font-size: 2.5rem; }
            .dashboard-header + p { font-size: 1rem; }
            .cards-grid { gap: 1.5rem; }
            .dashboard-card { padding: 1.8rem; }
            .dashboard-card .card-title { font-size: 1.2rem; }
            .dashboard-card .card-value { font-size: 2.5rem; }
            .dashboard-card .card-desc { font-size: 0.9rem; }
            .roommate-match-card { max-width: 90%; } /* Ensure it doesn't get too wide on smaller tablets */
        }

        @media (max-width: 900px) {
            .main-content { padding: 1.5rem; } /* Adjusted padding for smaller screens */
            header {
                flex-direction: column; /* Stack logo and nav vertically */
                align-items: flex-start; /* Align items to the start */
                padding: 1rem;
            }
            header .logo-container {
                margin-bottom: 1rem; /* Space between logo and stacked nav */
                margin-right: 0;
            }
            header nav {
                width: 100%; /* Make nav take full width */
                justify-content: center; /* Center buttons when wrapped */
                gap: 0.5rem; /* Smaller gap for mobile buttons */
            }
            header nav a {
                flex-grow: 1; /* Allow buttons to grow and fill space */
                text-align: center;
                padding: 0.75rem 1rem; /* Adjust button padding */
            }

            .dashboard-header { font-size: 2.2rem; margin-bottom: 1rem;}
            .dashboard-header + p { font-size: 0.95rem; margin-bottom: 1.5rem; }
            .dashboard-card { padding: 1.5rem; }
            .dashboard-card .card-title { font-size: 1.1rem; }
            .dashboard-card .card-value { font-size: 2.2rem; }
            .dashboard-card .card-desc { font-size: 0.85rem; }
            .roommate-match-card { max-width: 90%; } /* Ensure it doesn't get too wide on smaller tablets */
        }

        @media (max-width: 600px) {
            body { font-size: 14px; }
            .main-content { padding: 1rem; }
            header {
                padding: 0.75rem;
                margin-bottom: 1.5rem;
            }
            header .logo-container {
                font-size: 1.5rem;
                margin-bottom: 0.75rem;
            }
            header nav {
                gap: 0.4rem;
            }
            header nav a {
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
            }
            .dashboard-header { font-size: 1.8rem; margin-bottom: 0.75rem;}
            .dashboard-header + p { font-size: 0.85rem; margin-bottom: 1rem; }
            .dashboard-card { padding: 1rem; }
            .cards-grid { gap: 1rem; }
            .roommate-match-card { width: 98%; padding: 1.5rem; } /* Maximize space on small phones */
            .roommate-match-card h4 { font-size: 1.8rem; }
            .roommate-match-card p.text-lg { font-size: 0.9rem; }
            .compatibility-score { font-size: 2.2rem; }
            .roommate-match-card p.text-gray-700 { font-size: 0.85rem; }
            .swipe-buttons { gap: 1rem; margin-top: 1.5rem; }
            .swipe-button { width: 50px; height: 50px; font-size: 1.6rem; }
            .activity-item { padding-left: 2rem; padding-bottom: 1rem; margin-bottom: 1rem; }
            .activity-item::before { left: -0.4rem; width: 0.8rem; height: 0.8rem; }
            .activity-item .activity-icon { width: 2rem; height: 2rem; font-size: 1rem; margin-right: 0.5rem; }
            .main-content-tab-button { padding: 0.6rem 0.8rem; font-size: 0.9rem; }
        }

        /* --- Custom styles from profile.html, adapted for new theme --- */
        .glass-card {
            background: var(--bg-card); /* Use pure white for clean look */
            -webkit-backdrop-filter: none;
            backdrop-filter: none; /* Remove blur for simpler design */
            border-radius: 1.25rem; /* Consistent with new card radius */
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-md);
            transition: var(--transition-ease);
        }

        .glass-card:hover {
            transform: translateY(-7px) scale(1.01); /* Consistent with new card hover */
            box-shadow: var(--shadow-lg);
        }

        .gradient-text {
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--primary-dark-blue) 100%); /* Blue gradient */
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .btn-hover-effect {
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn-hover-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--primary-dark-blue), var(--primary-blue)); /* Blue gradient for buttons */
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .btn-hover-effect:hover::before {
            opacity: 1;
        }

        .btn-primary {
            background-color: var(--primary-blue); /* Use primary blue */
            color: white;
            padding: 0.9rem 1.8rem; /* Increased padding */
            border-radius: 0.75rem; /* More rounded */
            font-weight: 600;
            transition: var(--transition-ease);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark-blue); /* Darker shade of primary for hover */
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background-color: var(--secondary-gray);
            color: var(--primary-blue); /* Use primary blue for text */
            padding: 0.9rem 1.8rem; /* Increased padding */
            border-radius: 0.75rem; /* More rounded */
            font-weight: 600;
            transition: var(--transition-ease);
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary:hover {
            background-color: #d1d5db; /* Slightly darker gray */
            color: var(--primary-blue);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .spinner {
            border-top-color: var(--primary-blue); /* Use primary blue */
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.5em 1.5em;
            padding-right: 3rem;
        }

        /* --- Chat Modal Specific Styles --- */
        .chat-modal-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: var(--secondary-gray);
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chat-message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }

        .chat-message.sent {
            background-color: var(--primary-blue); /* Use primary blue */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }

        .chat-message.received {
            background-color: #e2e8f0; /* Light gray for received messages */
            color: var(--text-dark);
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input-container input {
            flex-grow: 1;
            border-radius: 0.75rem;
            border: 1px solid var(--border-subtle);
            padding: 0.75rem 1rem;
            font-size: 1rem;
        }

        .chat-input-container button {
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            background-color: var(--primary-blue); /* Use primary blue */
            color: white;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }

        .chat-input-container button:hover {
            background-color: var(--primary-dark-blue); /* Darker shade of primary */
        }

        /* Notification Bell Specific Styles */
        .notification-bell-container {
            position: relative;
            margin-left: 1rem; /* Space from other nav items */
        }

        .notification-bell-button {
            background: none;
            border: none;
            color: var(--text-dark);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .notification-bell-button:hover {
            background-color: var(--secondary-gray);
        }

        .notification-badge {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            background-color: #ef4444; /* Red for unread */
            color: white;
            border-radius: 50%;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: bold;
            min-width: 1.5rem;
            text-align: center;
            line-height: 1;
        }

        /* Notification Modal/Dropdown styles */
        .notification-modal {
            position: absolute;
            top: 100%; /* Position below the bell icon */
            right: 0;
            width: 350px; /* Adjust width as needed */
            max-height: 400px;
            overflow-y: auto;
            background-color: var(--bg-card);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-subtle);
            z-index: 100; /* Ensure it's above other content */
            padding: 1rem;
            transform: translateY(10px); /* Slight dropdown animation */
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease-out;
        }

        .notification-modal.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .notification-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item:hover {
            background-color: var(--secondary-gray);
        }

        .notification-item.unread {
            background-color: #fef2f2; /* Very light red for unread */
            font-weight: 600;
        }

        .notification-item .notification-message {
            font-size: 0.95rem;
            color: var(--text-dark);
            margin-bottom: 0.25rem;
        }

        .notification-item .notification-timestamp {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .notification-modal .mark-all-read-btn {
            width: 100%;
            padding: 0.75rem;
            margin-top: 0.5rem;
            background-color: var(--primary-blue); /* Use primary blue */
            color: white;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }

        .notification-modal .mark-all-read-btn:hover {
            background-color: var(--primary-dark-blue); /* Darker shade of primary */
        }

        /* NEW: User Type Selection in Modal */
        .user-type-selection-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            justify-content: center;
        }

        .user-type-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid var(--border-subtle);
            background-color: var(--secondary-gray);
            color: var(--text-dark);
        }

        .user-type-button.active {
            background-color: var(--primary-blue); /* Use primary blue */
            color: white;
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-md);
        }

        .user-type-button:hover:not(.active) {
            background-color: #e0e7ff; /* Light blue hover for inactive */
            border-color: var(--primary-blue);
        }

        /* NEW: Swipe buttons styling */
        .swipe-buttons {
            display: flex;
            justify-content: center;
            gap: 2rem; /* Increased gap for better touch targets */
            margin-top: 2.5rem; /* More space below the card */
            z-index: 10; /* Ensure buttons are above other content */
        }

        .swipe-button {
            width: 70px; /* Larger buttons */
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem; /* Larger icons */
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .swipe-button.skip {
            background-color: var(--reject-red);
            color: white;
            border: 2px solid var(--reject-dark-red);
        }

        .swipe-button.skip:hover {
            background-color: var(--reject-dark-red);
            transform: scale(1.1);
        }

        .swipe-button.like {
            background-color: var(--like-green);
            color: white;
            border: 2px solid var(--like-dark-green);
        }

        .swipe-button.like:hover {
            background-color: var(--like-dark-green);
            transform: scale(1.1);
        }

        /* NEW: Roommate card specific styling for better visuals */
        .roommate-match-card {
            width: 100%;
            max-width: 400px; /* Constrain width for better mobile experience */
            padding: 2.5rem;
            text-align: center;
            background: linear-gradient(135deg, #ffffff, var(--bg-page)); /* Subtle gradient background */
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.08); /* More pronounced shadow */
            border-radius: 1.5rem; /* Even more rounded */
            transition: transform 0.3s ease-out, box-shadow 0.3s ease-out;
            position: absolute; /* For swipe animation positioning */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Center the card */
            touch-action: pan-y; /* Allow vertical scrolling, but handle horizontal swipe */

            /* Variables for stacking effect */
            --card-offset-y: 0px;
            --card-scale: 1;
            --card-rotate-z: 0deg;
        }

        .roommate-match-card img {
            border: 5px solid var(--primary-blue); /* Use primary blue for border */
            box-shadow: var(--shadow-sm);
        }

        .roommate-match-card .compatibility-score {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-blue); /* Use primary blue */
            margin-top: 1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        /* Hide scrollbar for beauty, but allow scrolling */
        .chat-messages::-webkit-scrollbar,
        .notification-modal::-webkit-scrollbar,
        .activity-detail-modal-content::-webkit-scrollbar,
        .roommate-profile-form::-webkit-scrollbar {
            display: none;
        }
        .chat-messages,
        .notification-modal,
        .activity-detail-modal-content,
        .roommate-profile-form {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* NEW: Sticky Bottom Navbar */
        .bottom-navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-card);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: flex;
            justify-content: space-around;
            padding: 0.75rem 0;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            border-top: 1px solid var(--border-subtle);
        }

        .bottom-navbar a {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-medium);
            text-decoration: none;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }

        .bottom-navbar a i {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .bottom-navbar a.active,
        .bottom-navbar a:hover {
            color: var(--primary-blue); /* Use primary blue */
            background-color: var(--secondary-gray);
        }

        /* Adjust main content padding for bottom navbar */
        @media (max-width: 768px) {
            .main-content {
                padding-bottom: 5rem; /* Space for fixed bottom navbar */
            }
            header nav {
                display: none; /* Hide top nav on mobile, use bottom nav */
            }
        }
        @media (min-width: 769px) {
            .bottom-navbar {
                display: none; /* Hide bottom nav on desktop */
            }
        }

        /* AI Demo Badge */
        .ai-demo-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: var(--accent-mint); /* Mint green for AI badge */
            color: var(--primary-blue); /* Primary blue for text on AI badge */
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: var(--shadow-sm);
        }

        /* Tag input styling */
        .tag-input-container {
            min-height: 40px; /* Ensure visibility even with no tags */
            align-items: flex-start;
        }

        .tag {
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .tag.selected {
            background-color: var(--primary-blue);
            color: white;
        }

        .tag:not(.selected):hover {
            background-color: #e0e7ff; /* Light blue hover for unselected */
        }

        .add-custom-tag-input {
            border: 1px dashed var(--border-subtle);
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-medium);
            outline: none;
            flex-grow: 1; /* Allows input to take available space */
            min-width: 120px; /* Minimum width for input */
        }

        .add-custom-tag-input:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        .detail-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .detail-item i {
            color: var(--primary-blue);
            font-size: 1.1rem;
            margin-top: 0.2rem; /* Align icon with text */
        }

        .detail-item .font-semibold {
            flex-shrink: 0; /* Prevent label from shrinking */
        }

        .detail-item p {
            margin: 0;
            padding: 0;
        }

        .compatibility-score-modal {
            font-weight: bold;
            color: var(--primary-blue);
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Top Navigation Bar -->
        <header class="flex justify-between items-center mb-10 p-4 bg-white rounded-xl shadow-md border border-gray-200">
            <a href="{% url 'fairrent_app:index' %}" class="logo-container">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="color: var(--primary-blue);">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l-7 7m7-7v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="gradient-text">Roomto.Live</span>
            </a>
            <nav class="flex items-center">
                <a href="{% url 'fairrent_app:index' %}" class="btn-secondary flex items-center justify-center btn-hover-effect text-base px-4 py-2">
                    <i class="fas fa-home mr-2"></i>Homepage
                </a>
                <a href="#" class="btn-primary flex items-center justify-center btn-hover-effect text-base px-4 py-2" data-content-target="roommate-finder-section" id="roommate-finder-header-btn">
                    <i class="fas fa-users mr-2"></i>Roommate Finder
                </a>
                <a href="#" class="btn-primary flex items-center justify-center btn-hover-effect text-base px-4 py-2" data-content-target="my-services-section" id="my-services-header-btn">
                    <i class="fas fa-tools mr-2"></i>My Services
                </a>
                
                {# NEW: Notification Bell Button #}
                <div class="notification-bell-container">
                    <button id="notification-bell-btn" class="notification-bell-button" aria-label="Notifications">
                        <i class="fas fa-bell"></i>
                        {% if unread_notifications_count > 0 %}
                            <span id="notification-badge" class="notification-badge">{{ unread_notifications_count }}</span>
                        {% else %}
                            <span id="notification-badge" class="notification-badge hidden">0</span>
                        {% endif %}
                    </button>
                    {# Notification Dropdown/Modal #}
                    <div id="notification-modal" class="notification-modal hidden">
                        <h4 class="text-xl font-bold text-gray-900 mb-3">Notifications</h4>
                        <div id="notification-list" class="space-y-2">
                            {# Notifications will be loaded here by JavaScript #}
                            <p class="text-center text-gray-500 py-4" id="no-notifications-message">No new notifications.</p>
                        </div>
                        <button id="mark-all-read-btn" class="mark-all-read-btn mt-4 hidden">Mark All As Read</button>
                    </div>
                </div>

                <a href="{% url 'fairrent_app:logout' %}" class="btn-secondary flex items-center justify-center btn-hover-effect text-base px-4 py-2">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </a>
            </nav>
        </header>

        <!-- Dashboard Header -->
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-8">
            <div>
                <h1 class="dashboard-header">Welcome, <span class="gradient-text">{{ user_roommate_profile.name|default:user.username }}</span>!</h1>
                <p class="text-lg text-gray-600 mb-4 sm:mb-0">Here's a quick overview of your Roomto.Live activity.</p>
            </div>
        </div>

        <!-- Content Sections (Dynamically Swapped) -->
        <section id="dashboard-home" class="content-section active space-y-8 animate-fade-in">
            <div class="cards-grid">
                <!-- User Info Card (Compact) -->
                <div class="dashboard-card glass-card animate-fade-in delay-100">
                    <h3 class="card-title"><i class="fas fa-user-circle"></i> Your Profile Overview</h3>
                    <div class="flex items-center mb-5">
                        <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 mr-4 shadow-inner">
                            <i class="fas fa-user fa-2x"></i>
                        </div>
                        <div>
                            <p class="text-xl font-bold text-gray-900">{{ user_roommate_profile.name|default:user.username }}</p>
                            <p class="text-sm text-gray-500">{{ user.email }}</p>
                        </div>
                    </div>
                    <div class="text-base text-gray-600 space-y-2 border-t pt-5 mt-5 border-gray-100">
                        <p class="flex items-center"><i class="fas fa-calendar-alt w-5 mr-3 text-gray-400"></i>Joined {{ user.date_joined|date:"F Y" }}</p>
                        {% if user_roommate_profile %}
                            <p class="flex items-center"><i class="fas fa-tag w-5 mr-3 text-gray-400"></i>Role: {{ user_roommate_profile.get_user_type_display|default:'N/A' }}</p>
                            <p class="flex items-center"><i class="fas fa-map-marker-alt w-5 mr-3 text-gray-400"></i>Location: {{ user_roommate_profile.location|default:'N/A' }}</p>
                            <p class="flex items-center"><i class="fas fa-envelope w-5 mr-3 text-gray-400"></i>Contact: {{ user_roommate_profile.contact|default:'N/A' }}</p>
                            <p class="flex items-center"><i class="fas fa-briefcase w-5 mr-3 text-gray-400"></i>Occupation: {{ user_roommate_profile.occupation|default:'N/A' }}</p>

                            {% if user_roommate_profile.user_type == 'looking_for_room' %}
                                <p class="flex items-center"><i class="fas fa-venus-mars w-5 mr-3 text-gray-400"></i>Gender: {{ user_roommate_profile.get_gender_display|default:'N/A' }}</p>
                                <p class="flex items-center"><i class="fas fa-money-bill-wave w-5 mr-3 text-gray-400"></i>Budget: £{{ user_roommate_profile.budget|default:'N/A' }}</p>
                                <p class="flex items-center"><i class="fas fa-bed w-5 mr-3 text-gray-400"></i>Sleep: {{ user_roommate_profile.get_sleep_schedule_display|default:'N/A' }}</p>
                                <p class="flex items-center"><i class="fas fa-broom w-5 mr-3 text-gray-400"></i>Cleanliness: {{ user_roommate_profile.get_cleanliness_display|default:'N/A' }}</p>
                                <p class="flex items-center"><i class="fas fa-heart w-5 mr-3 text-gray-400"></i>Lifestyle: {{ user_roommate_profile.lifestyle_preferences|default:'N/A' }}</p>
                            {% elif user_roommate_profile.user_type == 'offering_room' %}
                                <p class="flex items-center"><i class="fas fa-door-open w-5 mr-3 text-gray-400"></i>Available Rooms: {{ user_roommate_profile.num_available_rooms|default:'N/A' }}</p>
                                <p class="flex items-center"><i class="fas fa-money-bill-wave w-5 mr-3 text-gray-400"></i>Rent: £{{ user_roommate_profile.rent_amount_offering|default:'N/A' }}</p>
                                <p class="flex items-center"><i class="fas fa-expand-arrows-alt w-5 mr-3 text-gray-400"></i>Room Size: {{ user_roommate_profile.room_size|default:'N/A' }}</p>
                                <p class="flex items-center"><i class="fas fa-calendar-alt w-5 mr-3 text-gray-400"></i>Available From: {{ user_roommate_profile.availability_date|date:"M d, Y"|default:'N/A' }}</p>
                                <p class="flex items-center"><i class="fas fa-gavel w-5 mr-3 text-gray-400"></i>House Rules: {{ user_roommate_profile.house_rules|default:'N/A' }}</p>
                                <p class="flex items-center"><i class="fas fa-couch w-5 mr-3 text-gray-400"></i>Furnished: {{ user_roommate_profile.furnished|default:'N/A' }}</p>
                                <p class="flex items-center"><i class="fas fa-file-invoice-dollar w-5 mr-3 text-gray-400"></i>Bills Included: {{ user_roommate_profile.bills_included|default:'N/A' }}</p>
                                {% if user_roommate_profile.property_photos %}
                                    <p class="flex items-center"><i class="fas fa-image w-5 mr-3 text-gray-400"></i>Photos: {{ user_roommate_profile.property_photos|default:'N/A' }}</p>
                                {% endif %}
                            {% endif %}
                            <p class="flex items-center"><i class="fas fa-info-circle w-5 mr-3 text-gray-400"></i>Bio: {{ user_roommate_profile.bio|default:'N/A' }}</p>
                        {% else %}
                            <p class="text-sm text-red-500">Profile not complete. Please create your profile!</p>
                        {% endif %}
                    </div>
                    <button id="edit-profile-btn-dashboard-home" class="btn-secondary w-full mt-6 flex items-center justify-center btn-hover-effect">
                        <i class="fas fa-edit mr-2"></i>{% if user_roommate_profile %}Edit Profile{% else %}Create Profile{% endif %}
                    </button>
                </div>

                <!-- Quick Stats Card -->
                <div class="dashboard-card glass-card animate-fade-in delay-200 col-span-1 md:col-span-1 lg:col-span-2">
                    <h3 class="card-title"><i class="fas fa-chart-bar"></i> Quick Stats</h3>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="p-4 bg-blue-50 rounded-lg shadow-sm">
                            <p class="text-3xl font-bold text-blue-600">{{ user_rent_checks|length }}</p>
                            <p class="text-gray-600 text-sm">Rent Checks</p>
                        </div>
                        <div class="p-4 bg-green-50 rounded-lg shadow-sm">
                            <p class="text-3xl font-bold text-green-600">{{ user_reviews|length }}</p>
                            <p class="text-gray-600 text-sm">Reviews Submitted</p>
                        </div>
                        <div class="p-4 bg-red-50 rounded-lg shadow-sm">
                            <p class="text-3xl font-bold text-red-600">{{ user_complaints|length }}</p>
                            <p class="text-gray-600 text-sm">Complaints Filed</p>
                        </div>
                        <div class="p-4 bg-purple-50 rounded-lg shadow-sm">
                            <p class="text-3xl font-bold text-purple-600">{{ user_liked_profiles|length }}</p>
                            <p class="text-gray-600 text-sm">Profiles Liked</p>
                        </div>
                        <!-- NEW: Contract Analyses Stat -->
                        <div class="p-4 bg-teal-50 rounded-lg shadow-sm">
                            <p class="text-3xl font-bold text-teal-600">{{ user_rental_contracts|length }}</p>
                            <p class="text-gray-600 text-sm">Contracts Analyzed</p>
                        </div>
                        <div class="p-4 bg-orange-50 rounded-lg shadow-sm">
                            <p class="text-3xl font-bold text-orange-600">{{ user_rent_declaration_checks|length }}</p>
                            <p class="text-gray-600 text-sm">Rent Declarations Checked</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Card (Full Width) -->
            <div class="dashboard-card glass-card animate-fade-in delay-300">
                <h3 class="card-title"><i class="fas fa-history"></i> Recent Activity</h3>
                <div id="recent-activity-list" class="space-y-3">
                    {% if recent_activities %}
                        {% for activity in recent_activities %}
                            <div class="activity-item cursor-pointer"
                                data-activity-type="{{ activity.type }}"
                                data-activity-details-id="activity_details_tab_{{ forloop.counter }}"
                                data-redirect-url="{% if activity.redirect_url %}{{ activity.redirect_url }}{% endif %}"
                                >
                                <div class="content flex items-start">
                                    <div class="activity-icon bg-{{ activity.color }}-100 text-{{ activity.color }}-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-lg">
                                        <i class="fas fa-{{ activity.icon }}"></i>
                                    </div>
                                    <div>
                                        <p class="text-gray-800 font-medium">{{ activity.description }}</p>
                                        <p class="text-sm text-gray-500">{{ activity.timestamp|date:"M d, Y H:i" }}</p>
                                    </div>
                                </div>
                                {# Store activity details in a script tag for safe JSON parsing #}
                                <script type="application/json" id="activity_details_tab_{{ forloop.counter }}">
                                    {{ activity.details|json_script:"activity_details_data" }}
                                </script>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-gray-500 py-4">No recent activity to display.</p>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- Roommate Finder Section (Full Page View) -->
        <section id="roommate-finder-section" class="content-section hidden space-y-8 animate-fade-in">
            <div class="glass-card p-8 flex flex-col items-center justify-center min-h-[500px]"> {# Added flex-col and min-h for centering #}
                <div class="flex justify-between items-center w-full mb-8">
                    <div>
                        <h3 class="text-3xl font-bold text-gray-900">AI Roommate Finder</h3>
                        <p class="text-gray-500 mt-1">Find your perfect roommate match — real people, real homes, no guesswork.</p>
                    </div>
                    <button id="edit-profile-btn-roommate-section" class="btn-primary flex items-center btn-hover-effect">
                        <i class="fas fa-edit mr-2"></i>{% if user_roommate_profile %}Edit Profile{% else %}Create Profile{% endif %}
                    </button>
                </div>
                <div id="roommate-match-container" class="relative w-full max-w-md min-h-[450px] bg-gray-50 rounded-xl border border-gray-200 overflow-hidden flex flex-col items-center justify-center">
                    <div id="roommate-matches-loader" class="absolute inset-0 flex flex-col items-center justify-center bg-white bg-opacity-90 rounded-xl hidden z-20">
                        <div class="spinner w-16 h-16 border-6 border-gray-200 rounded-full mb-4"></div>
                        <p class="text-gray-700 font-medium text-lg">Finding your perfect matches with AI...</p>
                    </div>
                    
                    <div id="roommate-match-card-display" class="flex flex-col items-center justify-center w-full h-full relative">
                        <!-- Dynamic match cards will be loaded here -->
                    </div>

                    <div id="roommate-prompt" class="text-center p-6 w-full h-full flex flex-col items-center justify-center z-10">
                        <i class="fas fa-users text-6xl text-gray-400 mb-6"></i>
                        <p class="mt-4 font-semibold text-gray-700 text-xl">Your potential matches will appear here.</p>
                        <p class="text-gray-500 mt-2 text-lg">{% if user.is_authenticated and user_roommate_profile and user_roommate_profile.user_type %}Click "Find Matches" to begin your search!{% else %}Create your profile and select your role to get started and find your ideal roommate.{% endif %}</p>
                        {% if user.is_authenticated and user_roommate_profile and user_roommate_profile.user_type %}<button id="find-matches-btn-inner" class="mt-8 btn-primary text-lg btn-hover-effect"><i class="fas fa-search mr-3"></i>Find Matches</button>{% endif %}
                    </div>

                    <div id="no-more-matches-prompt" class="hidden text-center p-6 w-full h-full flex flex-col items-center justify-content-center z-10">
                        <i class="fas fa-heart-broken text-6xl text-gray-400 mb-6"></i>
                        <p class="mt-4 font-semibold text-gray-700 text-xl">No more matches for now!</p>
                        <p class="text-gray-500 mt-2 text-lg">Check back later or refine your profile to discover new connections.</p>
                        <button id="reset-matches-btn" class="mt-8 btn-secondary text-lg btn-hover-effect"><i class="fas fa-redo mr-3"></i>Restart Matches</button>
                    </div>
                </div>
                
                {# Moved swipe buttons outside roommate-match-container for better clickability and styling #}
                <div id="swipe-buttons-container" class="swipe-buttons hidden">
                    <button id="skip-match-btn" class="swipe-button skip" aria-label="Skip Profile"><i class="fas fa-times"></i></button>
                    <button id="like-match-btn" class="swipe-button like" aria-label="Like Profile"><i class="fas fa-check"></i></button>
                </div>
            </div>
        </section>

        <!-- My Services & Activity Tabs -->
        <section id="my-services-section" class="content-section hidden space-y-8 animate-fade-in">
            <div class="glass-card p-6">
                <h3 class="card-title"><i class="fas fa-clipboard-list"></i> My Services & Activity</h3>
                
                <div class="main-content-tabs flex border-b-2 border-gray-200 mb-6">
                    <button class="main-content-tab-button active" data-tab-id="my-recent-activity-tab">Recent Activity</button>
                    <button class="main-content-tab-button" data-tab-id="my-service-results-tab">My Service Results</button>
                </div>

                <div id="my-recent-activity-tab" class="main-content-tab-content space-y-3">
                    {% if recent_activities %}
                        {% for activity in recent_activities %}
                            <div class="activity-item cursor-pointer"
                                data-activity-type="{{ activity.type }}"
                                data-activity-details-id="activity_details_tab_{{ forloop.counter }}"
                                data-redirect-url="{% if activity.redirect_url %}{{ activity.redirect_url }}{% endif %}"
                                >
                                <div class="content flex items-start">
                                    <div class="activity-icon bg-{{ activity.color }}-100 text-{{ activity.color }}-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-lg">
                                        <i class="fas fa-{{ activity.icon }}"></i>
                                    </div>
                                    <div>
                                        <p class="text-gray-800 font-medium">{{ activity.description }}</p>
                                        <p class="text-sm text-gray-500">{{ activity.timestamp|date:"M d, Y H:i" }}</p>
                                    </div>
                                </div>
                                {# Store activity details in a script tag for safe JSON parsing #}
                                <script type="application/json" id="activity_details_tab_{{ forloop.counter }}">
                                    {{ activity.details|json_script:"activity_details_data" }}
                                </script>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-center text-gray-500 py-4">No recent activity to display.</p>
                    {% endif %}
                </div>

                <div id="my-service-results-tab" class="main-content-tab-content hidden space-y-3"> {# Initially hidden #}
                    {% if user_rent_checks or user_reviews or user_complaints or user_forum_posts or user_liked_profiles or user_rental_contracts or user_rent_declaration_checks %}
                        {% for rent_result in user_rent_checks %}
                            <div class="service-result-card cursor-pointer rent-checker-result-card glass-card p-4 flex items-center"
                                data-activity-type="Rent Check"
                                data-service-details-id="service_details_rent_check_{{ forloop.counter }}"
                                >
                                <div class="icon-wrapper-small bg-blue-100 text-blue-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-lg">
                                    <i class="fas fa-gbp-sign"></i>
                                </div>
                                <div class="details">
                                    <p class="font-semibold text-gray-800">Rent Check for <span class="font-bold">{{ rent_result.postcode }}</span> ({{ rent_result.bedrooms }} bed)</p>
                                    <p class="text-gray-700">Estimated Rent: <span class="font-bold text-blue-600">£{{ rent_result.estimated_rent|floatformat:0 }}</span></p>
                                    <p class="text-sm text-gray-500">Checked on {{ rent_result.checked_at|date:"M d, Y" }}</p>
                                </div>
                            </div>
                            <script type="application/json" id="service_details_rent_check_{{ forloop.counter }}">
                                {
                                    "postcode": "{{ rent_result.postcode|escapejs }}",
                                    "bedrooms": "{{ rent_result.bedrooms|escapejs }}",
                                    "estimated_rent": {{ rent_result.estimated_rent|floatformat:0 }},
                                    "checked_at": "{{ rent_result.checked_at|date:"Y-m-d H:i:s" }}"
                                }
                            </script>
                        {% endfor %}

                        {% for review in user_reviews %}
                            <div class="service-result-card cursor-pointer glass-card p-4 flex items-center"
                                data-activity-type="Review"
                                data-service-details-id="service_details_review_{{ forloop.counter }}"
                                >
                                <div class="icon-wrapper-small bg-green-100 text-green-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-lg">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">Your Review for <span class="font-bold">{{ review.landlord_name }}</span> ({{ review.property_address }})</p>
                                    <p class="text-gray-700">Rating: <span class="font-bold text-green-600">{{ review.rating }} Stars</span></p>
                                    <p class="text-sm text-gray-500">"{{ review.comments|truncatechars:100 }}"</p>
                                    <p class="text-sm text-gray-500">Submitted on {{ review.reviewed_at|date:"M d, Y" }}</p>
                                </div>
                            </div>
                            <script type="application/json" id="service_details_review_{{ forloop.counter }}">
                                {
                                    "landlord_name": "{{ review.landlord_name|escapejs }}",
                                    "property_address": "{{ review.property_address|escapejs }}",
                                    "rating": {{ review.rating }},
                                    "comments": "{{ review.comments|escapejs }}",
                                    "reviewed_at": "{{ review.reviewed_at|date:"Y-m-d H:i:s" }}",
                                    "reviewer": "{{ review.user.username|escapejs }}"
                                }
                            </script>
                        {% endfor %}

                        {% for complaint in user_complaints %}
                            <div class="service-result-card cursor-pointer glass-card p-4 flex items-center"
                                data-activity-type="Complaint"
                                data-service-details-id="service_details_complaint_{{ forloop.counter }}"
                                >
                                <div class="icon-wrapper-small bg-red-100 text-red-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-lg">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">Complaint: <span class="font-bold">{{ complaint.get_issue_type_display }}</span> (<span class="font-bold">{{ complaint.property_address }}</span>)</p>
                                    <p class="text-gray-700">Status: <span class="text-orange-500 font-semibold">{{ complaint.get_status_display }}</span></p>
                                    <p class="text-sm text-gray-500">Submitted on {{ complaint.submitted_at|date:"M d, Y" }}</p>
                                </div>
                            </div>
                            <script type="application/json" id="service_details_complaint_{{ forloop.counter }}">
                                {
                                    "issue_type": "{{ complaint.get_issue_type_display|escapejs }}",
                                    "property_address": "{{ complaint.property_address|escapejs }}",
                                    "landlord_name": "{{ complaint.landlord_name|default:''|escapejs }}",
                                    "description": "{{ complaint.description|escapejs }}",
                                    "status": "{{ complaint.get_status_display|escapejs }}",  
                                    "submitted_at": "{{ complaint.submitted_at|date:"Y-m-d H:i:s" }}"
                                }
                            </script>
                        {% endfor %}

                        {% for post in user_forum_posts %}
                            <div class="service-result-card cursor-pointer glass-card p-4 flex items-center"
                                data-activity-type="Forum Post"
                                data-service-details-id="service_details_forum_post_{{ forloop.counter }}"
                                >
                                <div class="icon-wrapper-small bg-yellow-100 text-yellow-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-lg">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">Forum Post: <span class="font-bold">"{{ post.title }}"</span></p>
                                    <p class="text-gray-700">Category: <span class="font-bold">{{ post.get_category_display }}</span></p>
                                    <p class="text-sm text-gray-500">Posted on {{ post.created_at|date:"M d, Y" }}</p>
                                </div>
                            </div>
                            <script type="application/json" id="service_details_forum_post_{{ forloop.counter }}">
                                {
                                    "title": "{{ post.title|escapejs }}",
                                    "content": "{{ post.content|escapejs }}",
                                    "category": "{{ post.get_category_display|escapejs }}",
                                    "created_at": "{{ post.created_at|date:"Y-m-d H:i:s" }}",
                                    "author": "{{ post.user.username|escapejs }}"
                                }
                            </script>
                        {% endfor %}

                        {% for liked_profile in user_liked_profiles %}
                            <div class="service-result-card cursor-pointer glass-card p-4 flex items-center"
                                data-activity-type="Liked Profile"
                                data-service-details-id="service_details_liked_profile_{{ forloop.counter }}"
                                >
                                <div class="icon-wrapper-small bg-pink-100 text-pink-500 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-lg">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">Liked Profile: <span class="font-bold">{{ liked_profile.liked_user_name }}</span></p>
                                    <p class="text-gray-700">Compatibility: <span class="font-bold text-blue-600">{{ liked_profile.liked_user_compatibility_score|default:'N/A' }}%</span></p>
                                    <p class="text-sm text-gray-500">Liked on {{ liked_profile.liked_at|date:"M d, Y" }}</p>
                                </div>
                            </div>
                            <script type="application/json" id="service_details_liked_profile_{{ forloop.counter }}">
                                {
                                    "name": "{{ liked_profile.liked_user_name|escapejs }}",
                                    "age": {{ liked_profile.liked_user_age|default:"null" }},
                                    "gender": "{{ liked_profile.liked_user_gender|escapejs }}",
                                    "location": "{{ liked_profile.liked_user_location|escapejs }}",
                                    "budget": {{ liked_profile.liked_user_budget|default:"null" }},
                                    "bio": "{{ liked_profile.liked_user_bio|escapejs }}",
                                    "compatibility_score": {{ liked_profile.liked_user_compatibility_score|default:"null" }},
                                    "avatar_url": "{{ liked_profile.liked_user_avatar_url|escapejs }}",
                                    "uid": "{{ liked_profile.liked_user_uid|default:''|escapejs }}", {# IMPORTANT: Pass UID for chat #}
                                    "user_type": "{{ liked_profile.user_type|default:''|escapejs }}" {# NEW: Pass user_type for correct modal display #}
                                }
                            </script>
                        {% endfor %}

                        {% for contract in user_rental_contracts %}
                            <div class="service-result-card cursor-pointer glass-card p-4 flex items-center"
                                data-activity-type="Contract Analysis"
                                data-service-details-id="service_details_contract_{{ forloop.counter }}"
                                >
                                <div class="icon-wrapper-small bg-teal-100 text-teal-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-lg">
                                    <i class="fas fa-file-contract"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">Contract Analysis</p>
                                    <p class="text-gray-700">Analyzed on <span class="font-bold">{{ contract.analyzed_at|date:"M d, Y" }}</span></p>
                                    <p class="text-sm text-gray-500">Preview: "{{ contract.original_text|truncatechars:100 }}"</p>
                                </div>
                            </div>
                            <script type="application/json" id="service_details_contract_{{ forloop.counter }}">
                                {
                                    "original_text": "{{ contract.original_text|escapejs }}",
                                    "analysis_result": "{{ contract.analysis_result|escapejs }}",
                                    "analyzed_at": "{{ contract.analyzed_at|date:"Y-m-d H:i:s" }}"
                                }
                            </script>
                        {% endfor %}

                        {% for declaration_check in user_rent_declaration_checks %}
                            <div class="service-result-card cursor-pointer glass-card p-4 flex items-center"
                                data-activity-type="Rent Declaration Check"
                                data-service-details-id="service_details_declaration_check_{{ forloop.counter }}"
                                >
                                <div class="icon-wrapper-small bg-orange-100 text-orange-600 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-lg">
                                    <i class="fas fa-file-invoice-dollar"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">Rent Declaration Check for <span class="font-bold">{{ declaration_check.postcode }}</span></p>
                                    <p class="text-gray-700">Discrepancy: <span class="font-bold {% if declaration_check.discrepancy_found %}text-red-600{% else %}text-green-600{% endif %}">{{ declaration_check.discrepancy_found|yesno:"Found,None" }}</span></p>
                                    <p class="text-sm text-gray-500">Checked on {{ declaration_check.checked_at|date:"M d, Y" }}</p>
                                </div>
                            </div>
                            <script type="application/json" id="service_details_declaration_check_{{ forloop.counter }}">
                                {
                                    "postcode": "{{ declaration_check.postcode|escapejs }}",
                                    "bedrooms": "{{ declaration_check.bedrooms|escapejs }}",
                                    "actual_rent_paid": {{ declaration_check.actual_rent_paid }},
                                    "council_tax_band": "{{ declaration_check.council_tax_band|escapejs }}",
                                    "estimated_council_tax": {{ declaration_check.estimated_council_tax|default:"null" }},
                                    "discrepancy_found": {{ declaration_check.discrepancy_found|lower }},
                                    "analysis_result": "{{ declaration_check.analysis_result|escapejs }}",
                                    "checked_at": "{{ declaration_check.checked_at|date:"Y-m-d H:i:s" }}"
                                }
                            </script>
                        {% endfor %}

                    {% else %}
                        <p class="text-center text-gray-500 py-2">No service results to display yet.</p>
                    {% endif %}
                </div>
            </div>
        </section>
    </main>

    <!-- Roommate Profile Edit Modal -->
    <div id="profile-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="profile-modal-title">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto relative transform transition-all sm:my-8 sm:align-middle sm:max-w-xl sm:w-full p-8">
            <button type="button" id="close-profile-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none p-2 rounded-full hover:bg-gray-100 transition-colors" aria-label="Close Profile Modal">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <form id="roommate-profile-form" class="space-y-6">
                <h3 id="profile-modal-title" class="text-3xl font-bold mb-6 text-gray-900">Your Roommate Profile</h3>
                
                <!-- NEW: User Type Selection -->
                <div class="flex flex-col items-center mb-6">
                    <label class="block text-lg font-semibold text-gray-800 mb-3">What are you looking for?</label>
                    <div class="user-type-selection-container">
                        <button type="button" id="user-type-looking-btn" class="user-type-button" data-user-type="looking_for_room">
                            <i class="fas fa-search"></i> I'm looking for a room
                        </button>
                        <button type="button" id="user-type-offering-btn" class="user-type-button" data-user-type="offering_room">
                            <i class="fas fa-home"></i> I'm offering a room
                        </button>
                    </div>
                    <input type="hidden" id="user-type-hidden" name="user_type" value="{{ user_roommate_profile.user_type|default:'' }}">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                        <input type="text" id="name" name="name" value="{{ user_roommate_profile.name|default:'' }}"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3"
                               placeholder="e.g., John Doe">
                    </div>
                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Location (Desired / Property)</label>
                        <input type="text" id="location" name="location" value="{{ user_roommate_profile.location|default:'' }}"
                               placeholder="e.g., East London"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3">
                    </div>
                    {# NEW: Contact and Occupation fields for both types #}
                    <div>
                        <label for="contact" class="block text-sm font-medium text-gray-700 mb-1">Contact Email/Phone (Optional)</label>
                        <input type="text" id="contact" name="contact" value="{{ user_roommate_profile.contact|default:'' }}"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3"
                               placeholder="e.g., your@email.com or 07XXXXXXXXX">
                    </div>
                    <div>
                        <label for="occupation" class="block text-sm font-medium text-gray-700 mb-1">Occupation (Optional)</label>
                        <input type="text" id="occupation" name="occupation" value="{{ user_roommate_profile.occupation|default:'' }}"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3"
                               placeholder="e.g., Student, Software Engineer">
                    </div>
                </div>

                <!-- Fields for "Looking for a Room" -->
                <div id="looking-for-room-fields" class="space-y-6 {% if user_roommate_profile.user_type == 'offering_room' %}hidden{% endif %}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="age" class="block text-sm font-medium text-gray-700 mb-1">Age</label>
                            <input type="number" id="age" name="age" value="{{ user_roommate_profile.age|default:'' }}"
                                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3"
                                   min="18" max="99" placeholder="e.g., 25">
                        </div>
                        <div>
                            <label for="gender" class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                            <select id="gender" name="gender"
                                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3">
                                <option value="">Select Gender</option>
                                <option value="male" {% if user_roommate_profile.gender == 'male' %}selected{% endif %}>Male</option>
                                <option value="female" {% if user_roommate_profile.gender == 'female' %}selected{% endif %}>Female</option>
                                <option value="other" {% if user_roommate_profile.gender == 'other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="sleep_schedule" class="block text-sm font-medium text-gray-700 mb-1">Sleep Schedule</label>
                            <select id="sleep_schedule" name="sleep_schedule"
                                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3">
                                <option value="">Select Schedule</option>
                                <option value="early_bird" {% if user_roommate_profile.sleep_schedule == 'early_bird' %}selected{% endif %}>Early Bird</option>
                                <option value="night_owl" {% if user_roommate_profile.sleep_schedule == 'night_owl' %}selected{% endif %}>Night Owl</option>
                                <option value="flexible" {% if user_roommate_profile.sleep_schedule == 'flexible' %}selected{% endif %}>Flexible</option>
                            </select>
                        </div>
                        <div>
                            <label for="cleanliness" class="block text-sm font-medium text-gray-700 mb-1">Cleanliness</label>
                            <select id="cleanliness" name="cleanliness"
                                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3">
                                <option value="">Select Cleanliness</option>
                                <option value="very_tidy" {% if user_roommate_profile.cleanliness == 'very_tidy' %}selected{% endif %}>Very Tidy</option>
                                <option value="average" {% if user_roommate_profile.cleanliness == 'average' %}selected{% endif %}>Average</option>
                                <option value="relaxed" {% if user_roommate_profile.cleanliness == 'relaxed' %}selected{% endif %}>Relaxed</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="budget" class="block text-sm font-medium text-gray-700 mb-1">Max Budget (£/month)</label>
                            <input type="number" id="budget" name="budget" value="{{ user_roommate_profile.budget|default:'' }}"
                                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3"
                                   min="100" max="5000" placeholder="e.g., 800">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Lifestyle Preferences</label>
                        <div id="lifestyle-preferences-tags" class="tag-input-container flex flex-wrap gap-2 p-2 border border-gray-300 rounded-lg bg-gray-50">
                            <!-- Tags will be injected here by JavaScript -->
                        </div>
                        <input type="hidden" id="lifestyle_preferences_hidden" name="lifestyle_preferences" value="{{ user_roommate_profile.lifestyle_preferences|default:'' }}">
                    </div>
                </div>

                <!-- Fields for "Offering a Room" -->
                <div id="offering-room-fields" class="space-y-6 {% if user_roommate_profile.user_type != 'offering_room' %}hidden{% endif %}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="num_available_rooms" class="block text-sm font-medium text-gray-700 mb-1">Number of Available Rooms</label>
                            <input type="number" id="num_available_rooms" name="num_available_rooms" value="{{ user_roommate_profile.num_available_rooms|default:'' }}"
                                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3"
                                   min="1" max="10" placeholder="e.g., 1">
                        </div>
                        <div>
                            <label for="rent_amount_offering" class="block text-sm font-medium text-gray-700 mb-1">Rent Amount (£/month per room)</label>
                            <input type="number" id="rent_amount_offering" name="rent_amount_offering" value="{{ user_roommate_profile.rent_amount_offering|default:'' }}"
                                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3"
                                   min="100" max="5000" placeholder="e.g., 750">
                        </div>
                        <div>
                            <label for="room_size" class="block text-sm font-medium text-gray-700 mb-1">Room Size</label>
                            <select id="room_size" name="room_size"
                                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3">
                                <option value="">Select Room Size</option>
                                <option value="single" {% if user_roommate_profile.room_size == 'single' %}selected{% endif %}>Single</option>
                                <option value="double" {% if user_roommate_profile.room_size == 'double' %}selected{% endif %}>Double</option>
                                <option value="en_suite" {% if user_roommate_profile.room_size == 'en_suite' %}selected{% endif %}>En-suite</option>
                                <option value="studio" {% if user_roommate_profile.room_size == 'studio' %}selected{% endif %}>Studio</option>
                            </select>
                        </div>
                        <div>
                            <label for="availability_date" class="block text-sm font-medium text-gray-700 mb-1">Availability Date</label>
                            <input type="date" id="availability_date" name="availability_date" value="{{ user_roommate_profile.availability_date|date:'Y-m-d'|default:'' }}"
                                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3">
                        </div>
                        {# NEW: Furnished and Bills Included #}
                        <div class="col-span-1">
                            <label for="furnished" class="block text-sm font-medium text-gray-700 mb-1">Furnished?</label>
                            <select id="furnished" name="furnished"
                                    class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3">
                                <option value="">Select Option</option>
                                <option value="yes" {% if user_roommate_profile.furnished == 'yes' %}selected{% endif %}>Yes</option>
                                <option value="no" {% if user_roommate_profile.furnished == 'no' %}selected{% endif %}>No</option>
                                <option value="partially" {% if user_roommate_profile.furnished == 'partially' %}selected{% endif %}>Partially</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label for="bills_included" class="block text-sm font-medium text-gray-700 mb-1">Bills Included?</label>
                            <select id="bills_included" name="bills_included"
                                    class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3">
                                <option value="">Select Option</option>
                                <option value="yes" {% if user_roommate_profile.bills_included == 'yes' %}selected{% endif %}>Yes</option>
                                <option value="no" {% if user_roommate_profile.bills_included == 'no' %}selected{% endif %}>No</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">House Rules (comma-separated)</label>
                        <div id="house-rules-tags" class="tag-input-container flex flex-wrap gap-2 p-2 border border-gray-300 rounded-lg bg-gray-50">
                            <!-- Tags will be injected here by JavaScript -->
                        </div>
                        <input type="hidden" id="house_rules_hidden" name="house_rules" value="{{ user_roommate_profile.house_rules|default:'' }}">
                    </div>
                    <div class="mt-4">
                        <label for="property_photos" class="block text-sm font-medium text-gray-700 mb-1">Property Photos (comma-separated URLs)</label>
                        <textarea id="property_photos" name="property_photos" rows="2"
                                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3"
                                   placeholder="e.g., https://example.com/pic1.jpg, https://example.com/pic2.jpg">{{ user_roommate_profile.property_photos|default:'' }}</textarea>
                        <p class="text-xs text-gray-500 mt-1">Enter URLs separated by commas. Max 5 photos.</p>
                    </div>
                </div>

                <div class="mt-4">
                    <label for="bio" class="block text-sm font-medium text-gray-700 mb-1">Bio</label>
                    <textarea id="bio" name="bio" rows="4"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3"
                               placeholder="Tell us about yourself and what you're looking for... (max 500 words)">{{ user_roommate_profile.bio|default:'' }}</textarea>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="profile-form-cancel-btn" class="btn-secondary btn-hover-effect">Cancel</button>
                    <button type="submit" class="btn-primary btn-hover-effect">Save Profile</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generic Activity/Service Details Modal -->
    <div id="activity-details-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="activity-modal-title">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-8 relative transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full">
            <button type="button" id="close-activity-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none p-2 rounded-full hover:bg-gray-100 transition-colors">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <div id="activity-modal-content" class="text-left activity-detail-modal-content">
                <!-- Activity/Service details will be injected here by JavaScript -->
            </div>
            <div class="mt-6 text-center space-y-3">
                <button id="modal-redirect-btn" class="btn-primary hidden px-6 py-2">Go to Service</button>
                <button id="modal-start-chat-btn" class="btn-primary hidden px-6 py-2"><i class="fas fa-comment-dots mr-2"></i>Start Chat</button>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="chat-modal-title">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg h-[80vh] flex flex-col relative transform transition-all sm:my-8 sm:align-middle sm:max-w-xl sm:w-full p-8">
            <button type="button" id="close-chat-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none p-2 rounded-full hover:bg-gray-100 transition-colors">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <h3 id="chat-modal-title" class="text-2xl font-bold text-gray-900 mb-4">Chat with <span id="chat-partner-name"></span></h3>
            <div id="chat-messages" class="chat-messages">
                <!-- Chat messages will be loaded here -->
            </div>
            <div class="chat-input-container">
                <input type="text" id="chat-message-input" placeholder="Type your message..." class="flex-grow rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3">
                <button id="send-chat-message-btn"><i class="fas fa-paper-plane"></i> Send</button>
            </div>
        </div>
    </div>

    <!-- Alert/Toast Notification -->
    <div id="alert-toast" class="fixed bottom-5 right-5 z-50 hidden p-4 rounded-lg text-white transition-transform transform translate-y-20">
        <p id="alert-message"></p>
    </div>

    <!-- NEW: Chat Request Confirmation Modal -->
    <div id="chat-request-confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="chat-request-confirm-title">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-8 relative text-center">
            <h3 id="chat-request-confirm-title" class="text-xl font-bold text-gray-900 mb-4">Send Chat Request?</h3>
            <p class="text-gray-700 mb-6">Would you like to send a chat request to <span id="confirm-chat-partner-name" class="font-semibold"></span>?</p>
            <div class="flex justify-center space-x-4">
                <button type="button" id="cancel-chat-request-btn" class="btn-secondary">Cancel</button>
                <button type="button" id="send-chat-request-btn" class="btn-primary">Send Request</button>
            </div>
        </div>
    </div>

    {# NEW: Sticky Bottom Navigation Bar for Mobile #}
    <nav class="bottom-navbar">
        <a href="{% url 'fairrent_app:profile' %}" class="active" data-content-target="dashboard-home">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
        </a>
        <a href="#" data-content-target="roommate-finder-section" id="bottom-nav-roommate-finder">
            <i class="fas fa-users"></i>
            <span>Matches</span>
        </a>
        <a href="#" data-content-target="my-services-section" id="bottom-nav-my-services">
            <i class="fas fa-tools"></i>
            <span>Services</span>
        </a>
        <a href="#" id="bottom-nav-chat">
            <i class="fas fa-comment-dots"></i>
            <span>Chat</span>
        </a>
        <a href="{% url 'fairrent_app:logout' %}">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </a>
    </nav>

    {# NEW: Hidden script tag to pass Django URLs to JavaScript #}
    <script type="application/json" id="django-urls-data">
        {
            "API_GET_NOTIFICATIONS_URL": "{% url 'fairrent_app:api_get_notifications' %}",
            "API_MARK_NOTIFICATION_READ_URL": "{% url 'fairrent_app:api_mark_notification_read' %}",
            "API_SAVE_ROOMMATE_PROFILE_URL": "{% url 'fairrent_app:api_save_roommate_profile' %}",
            "API_FIND_ROOMMATE_MATCHES_URL": "{% url 'fairrent_app:api_find_roommate_matches' %}",
            "API_SAVE_LIKED_PROFILE_URL": "{% url 'fairrent_app:api_save_liked_profile' %}",
            "API_SEND_CHAT_MESSAGE_URL": "{% url 'fairrent_app:api_send_chat_message' %}",
            "API_GET_CHAT_MESSAGES_BASE_URL": "{% url 'fairrent_app:api_get_chat_messages' 'DUMMY_UID' %}"
        }
    </script>

    <script>
        // Parse Django URLs from the hidden script tag
        const djangoUrlsElement = document.getElementById('django-urls-data');
        // Check if the element exists and has content before parsing
        let djangoUrls = {};
        if (djangoUrlsElement && djangoUrlsElement.textContent) {
            try {
                djangoUrls = JSON.parse(djangoUrlsElement.textContent);
            } catch (e) {
                console.error("Error parsing Django URLs from script tag:", e);
            }
        }

        // Assign to window scope for access from main.js
        // Provide fallback empty strings if URLs are not defined, to prevent errors
        window.API_GET_NOTIFICATIONS_URL = djangoUrls.API_GET_NOTIFICATIONS_URL || '';
        window.API_MARK_NOTIFICATION_READ_URL = djangoUrls.API_MARK_NOTIFICATION_READ_URL || '';
        window.API_SAVE_ROOMMATE_PROFILE_URL = djangoUrls.API_SAVE_ROOMMATE_PROFILE_URL || '';
        window.API_FIND_ROOMMATE_MATCHES_URL = djangoUrls.API_FIND_ROOMMATE_MATCHES_URL || '';
        window.API_SAVE_LIKED_PROFILE_URL = djangoUrls.API_SAVE_LIKED_PROFILE_URL || '';
        window.API_SEND_CHAT_MESSAGE_URL = djangoUrls.API_SEND_CHAT_MESSAGE_URL || '';
        // Correctly handle the base URL for chat messages, replacing the dummy UID
        window.API_GET_CHAT_MESSAGES_BASE_URL = (djangoUrls.API_GET_CHAT_MESSAGES_BASE_URL || '').replace('DUMMY_UID', '');


        // Global variable for current user's UID (Django PK)
        window.currentUserId = "{{ request.user.pk|default:'null' }}";
        // Ensure these are correctly populated from Django context for profile editing
        window.currentUserProfileType = "{{ user_roommate_profile.user_type|default:'' }}";
        window.currentUserLocation = "{{ user_roommate_profile.location|default:'' }}";
        window.currentUserBio = "{{ user_roommate_profile.bio|default:'' }}";
        window.currentUserAge = "{{ user_roommate_profile.age|default:'' }}";
        window.currentUserGender = "{{ user_roommate_profile.gender|default:'' }}";
        window.currentUserBudget = "{{ user_roommate_profile.budget|default:'' }}";
        window.currentUserSleepSchedule = "{{ user_roommate_profile.sleep_schedule|default:'' }}";
        window.currentUserCleanliness = "{{ user_roommate_profile.cleanliness|default:'' }}";
        window.currentUserLifestyle = "{{ user_roommate_profile.lifestyle_preferences|default:'' }}";
        window.currentUserNumRooms = "{{ user_roommate_profile.num_available_rooms|default:'' }}";
        window.currentUserRentOffering = "{{ user_roommate_profile.rent_amount_offering|default:'' }}";
        window.currentUserRoomSize = "{{ user_roommate_profile.room_size|default:'' }}";
        window.currentUserHouseRules = "{{ user_roommate_profile.house_rules|default:'' }}";
        window.currentUserAvailabilityDate = "{{ user_roommate_profile.availability_date|date:'Y-m-d'|default:'' }}";
        window.currentUserFurnished = "{{ user_roommate_profile.furnished|default:'' }}";
        window.currentUserBillsIncluded = "{{ user_roommate_profile.bills_included|default:'' }}";


        var chatPartnerUid = null;
        var chatPartnerName = '';
        var chatPollingInterval = null;
        var notificationPollingInterval = null; // New: Polling interval for notifications

        // Helper function to show toast notifications
        function showToast(message, type = 'success') {
            const toast = document.getElementById('alert-toast');
            const msgElement = document.getElementById('alert-message');
            msgElement.textContent = message;
            
            toast.className = 'fixed bottom-5 right-5 z-50 p-4 rounded-lg text-white transition-transform transform';
            if (type === 'success') {
                toast.classList.add('bg-green-500');
            } else if (type === 'error') {
                toast.classList.add('bg-red-500');
            } else if (type === 'info') { // Added info type
                toast.classList.add('bg-blue-500');
            } else {
                toast.classList.add('bg-gray-700');
            }
            
            toast.classList.remove('translate-y-20'); // Show toast
            setTimeout(() => {
                toast.classList.add('translate-y-20'); // Hide toast
            }, 3000);
        }

        // --- Dashboard Navigation Logic ---
        const contentSections = document.querySelectorAll('.content-section');
        const headerNavButtons = document.querySelectorAll('header nav a[data-content-target]');
        const bottomNavButtons = document.querySelectorAll('.bottom-navbar a[data-content-target]'); // NEW for bottom nav

        // Function to switch content sections
        function switchContentSection(targetId) {
            contentSections.forEach(section => section.classList.add('hidden'));
            const targetSection = document.getElementById(targetId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.add('animate-fade-in'); // Re-apply animation on switch
            }

            // Update active state for header buttons
            headerNavButtons.forEach(btn => {
                if (btn.dataset.contentTarget === targetId) {
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-primary');
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-secondary');
                }
            });

            // Update active state for bottom nav buttons
            bottomNavButtons.forEach(btn => {
                if (btn.dataset.contentTarget === targetId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // Event listeners for header navigation buttons
        headerNavButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = button.dataset.contentTarget;
                if (targetId) {  
                    e.preventDefault();  
                    window.location.hash = targetId;
                    switchContentSection(targetId);
                }
            });
        });

        // Event listeners for bottom navigation buttons
        bottomNavButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = button.dataset.contentTarget;
                if (targetId) {
                    e.preventDefault();
                    window.location.hash = targetId;
                    switchContentSection(targetId);
                } else if (button.id === 'bottom-nav-chat') { // Special handling for chat button
                    e.preventDefault();
                    // For now, if no specific chat partner is selected, maybe open a "chat list" or a default chat
                    // Or, if the user is on the matches page, this could lead to the last chatted person
                    // For simplicity, let's just show a toast if no chat is active.
                    showToast("Please select a match to start chatting!", "info");
                }
            });
        });


        // Initialize active content section on load based on URL hash or default
        document.addEventListener('DOMContentLoaded', () => {
            const initialSectionId = window.location.hash ? window.location.hash.substring(1) : 'dashboard-home';
            switchContentSection(initialSectionId);
        });

        // --- Roommate Profile Modal Logic ---
        const profileModal = document.getElementById('profile-modal');
        const editProfileBtnDashboardHome = document.getElementById('edit-profile-btn-dashboard-home');
        const editProfileBtnRoommateSection = document.getElementById('edit-profile-btn-roommate-section');
        const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
        const profileFormCancelBtn = document.getElementById('profile-form-cancel-btn');
        const roommateProfileForm = document.getElementById('roommate-profile-form');
        
        const userTypeLookingBtn = document.getElementById('user-type-looking-btn');
        const userTypeOfferingBtn = document.getElementById('user-type-offering-btn');
        const userTypeHiddenInput = document.getElementById('user-type-hidden');

        const lookingForRoomFields = document.getElementById('looking-for-room-fields');
        const offeringRoomFields = document.getElementById('offering-room-fields');

        const lifestylePreferencesTagsContainer = document.getElementById('lifestyle-preferences-tags');
        const lifestylePreferencesHiddenInput = document.getElementById('lifestyle_preferences_hidden');
        const houseRulesTagsContainer = document.getElementById('house-rules-tags');
        const houseRulesHiddenInput = document.getElementById('house_rules_hidden');

        const profileLocationInput = document.getElementById('location');
        const profileNameInput = document.getElementById('name');
        // NEW: Contact and Occupation inputs
        const contactInput = document.getElementById('contact');
        const occupationInput = document.getElementById('occupation');
        // NEW: Furnished and Bills Included selects
        const furnishedSelect = document.getElementById('furnished');
        const billsIncludedSelect = document.getElementById('bills_included');
        // NEW: Property Photos textarea
        const propertyPhotosTextarea = document.getElementById('property_photos');


        // Pre-defined lifestyle preferences and house rules
        const ALL_LIFESTYLE_PREFERENCES = [
            'Quiet', 'Social', 'Pet-Friendly', 'Clean', 'Messy', 'Early Bird',
            'Night Owl', 'Studious', 'Party-goer', 'Vegetarian', 'Vegan',
            'Cooks Often', 'Rarely Cooks', 'Non-Smoker', 'Smoker', 'Introvert', 'Extrovert'
        ];

        // EXPANDED HOUSE RULES
        const ALL_HOUSE_RULES = [
            'No Pets', 'No Smoking', 'Quiet Hours (after 10 PM)', 'Guests Allowed', 'No Parties',
            'Shared Chores (rota)', 'Bills Included', 'Parking Available', 'Vegan/Vegetarian Friendly',
            'Alcohol-Free', 'Drug-Free', 'LGBTQ+ Friendly', 'Professional', 'Student'
        ];

        // Function to render tags (reusable for lifestyle and house rules)
        function renderTags(container, hiddenInput, allOptions, selectedValues = []) {
            if (!container) return;
            container.innerHTML = ''; // Clear existing tags
            const currentSelected = new Set(selectedValues);

            allOptions.forEach(option => {
                const tag = document.createElement('span');
                tag.className = 'inline-block text-sm px-3 py-1 rounded-full cursor-pointer mr-2 mb-2 transition-colors duration-200 tag';
                tag.textContent = option;
                if (currentSelected.has(option)) {
                    tag.classList.add('bg-blue-500', 'text-white', 'selected'); /* Use primary blue for selected tags */
                    tag.classList.remove('bg-gray-200', 'text-gray-800');
                } else {
                    tag.classList.remove('bg-blue-500', 'text-white');
                    tag.classList.add('bg-gray-200', 'text-gray-800');
                }
                tag.addEventListener('click', () => {
                    tag.classList.toggle('selected');
                    tag.classList.toggle('bg-blue-500');
                    tag.classList.toggle('text-white');
                    tag.classList.toggle('bg-gray-200');
                    tag.classList.toggle('text-gray-800');
                    updateHiddenInput(container, hiddenInput);
                });
                container.appendChild(tag);
            });

            // Add an input for custom tags
            const customTagInput = document.createElement('input');
            customTagInput.type = 'text';
            customTagInput.placeholder = 'Add custom tag...';
            customTagInput.className = 'add-custom-tag-input';
            customTagInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && customTagInput.value.trim() !== '') {
                    e.preventDefault(); // Prevent form submission
                    const newTagText = customTagInput.value.trim();
                    if (!allOptions.includes(newTagText) && !Array.from(container.querySelectorAll('.tag.selected')).map(t => t.textContent).includes(newTagText)) {
                        // Add new tag to options and select it
                        allOptions.push(newTagText); // Add to the list of all options
                        renderTags(container, hiddenInput, allOptions, Array.from(container.querySelectorAll('.tag.selected')).map(t => t.textContent).concat(newTagText));
                        updateHiddenInput(container, hiddenInput);
                    }
                    customTagInput.value = ''; // Clear input
                }
            });
            container.appendChild(customTagInput);
        }

        // Function to update hidden input based on selected tags (reusable)
        function updateHiddenInput(container, hiddenInput) {
            if (!container || !hiddenInput) return;
            const selectedTags = Array.from(container.querySelectorAll('.tag.selected')).map(tag => tag.textContent);
            hiddenInput.value = selectedTags.join(', ');
        }

        // Function to toggle profile form fields based on user type
        function toggleProfileFields(userType) {
            if (userType === 'looking_for_room') {
                lookingForRoomFields.classList.remove('hidden');
                offeringRoomFields.classList.add('hidden');
                userTypeLookingBtn.classList.add('active');
                userTypeOfferingBtn.classList.remove('active');
            } else if (userType === 'offering_room') {
                offeringRoomFields.classList.remove('hidden');
                lookingForRoomFields.classList.add('hidden');
                userTypeOfferingBtn.classList.add('active');
                userTypeLookingBtn.classList.remove('active');
            } else { // No user type selected yet
                lookingForRoomFields.classList.add('hidden');
                offeringRoomFields.classList.add('hidden');
                userTypeLookingBtn.classList.remove('active');
                userTypeOfferingBtn.classList.remove('active');
            }
            userTypeHiddenInput.value = userType;
        }

        // Function to open profile modal and populate fields
        const openProfileModal = () => {
            // Populate common fields
            document.getElementById('name').value = "{{ user_roommate_profile.name|default:'' }}";
            document.getElementById('location').value = "{{ user_roommate_profile.location|default:'' }}";
            document.getElementById('bio').value = "{{ user_roommate_profile.bio|default:'' }}";
            contactInput.value = "{{ user_roommate_profile.contact|default:'' }}"; // NEW
            occupationInput.value = "{{ user_roommate_profile.occupation|default:'' }}"; // NEW


            // Populate and show fields based on existing user_type
            const currentUserType = "{{ user_roommate_profile.user_type|default:'' }}";
            if (currentUserType === 'looking_for_room') {
                document.getElementById('age').value = "{{ user_roommate_profile.age|default:'' }}";
                document.getElementById('gender').value = "{{ user_roommate_profile.gender|default:'' }}";
                document.getElementById('sleep_schedule').value = "{{ user_roommate_profile.sleep_schedule|default:'' }}";
                document.getElementById('cleanliness').value = "{{ user_roommate_profile.cleanliness|default:'' }}";
                document.getElementById('budget').value = "{{ user_roommate_profile.budget|default:'' }}";
                const currentLifestylePrefs = "{{ user_roommate_profile.lifestyle_preferences|default:'' }}".split(',').map(item => item.trim()).filter(item => item.length > 0);
                renderTags(lifestylePreferencesTagsContainer, lifestylePreferencesHiddenInput, ALL_LIFESTYLE_PREFERENCES, currentLifestylePrefs);
            } else if (currentUserType === 'offering_room') {
                document.getElementById('num_available_rooms').value = "{{ user_roommate_profile.num_available_rooms|default:'' }}";
                document.getElementById('rent_amount_offering').value = "{{ user_roommate_profile.rent_amount_offering|default:'' }}";
                document.getElementById('room_size').value = "{{ user_roommate_profile.room_size|default:'' }}";
                document.getElementById('availability_date').value = "{{ user_roommate_profile.availability_date|date:'Y-m-d'|default:'' }}";
                propertyPhotosTextarea.value = "{{ user_roommate_profile.property_photos|default:'' }}";
                furnishedSelect.value = "{{ user_roommate_profile.furnished|default:'' }}"; // NEW
                billsIncludedSelect.value = "{{ user_roommate_profile.bills_included|default:'' }}"; // NEW
                const currentHouseRules = "{{ user_roommate_profile.house_rules|default:'' }}".split(',').map(item => item.trim()).filter(item => item.length > 0);
                renderTags(houseRulesTagsContainer, houseRulesHiddenInput, ALL_HOUSE_RULES, currentHouseRules);
            }
            toggleProfileFields(currentUserType); // Set initial active state and show/hide fields

            if (profileModal) {
                profileModal.classList.remove('hidden');
                profileModal.classList.add('flex');
            }
        };

        if (editProfileBtnDashboardHome) {
            editProfileBtnDashboardHome.addEventListener('click', openProfileModal);
        }
        if (editProfileBtnRoommateSection) {
            editProfileBtnRoommateSection.addEventListener('click', openProfileModal);
        }

        if (closeProfileModalBtn) {
            closeProfileModalBtn.addEventListener('click', () => {
                if (profileModal) {
                    profileModal.classList.add('hidden');
                    profileModal.classList.remove('flex');
                }
            });
        }

        if (profileFormCancelBtn) {
            profileFormCancelBtn.addEventListener('click', () => {
                if (profileModal) {
                    profileModal.classList.add('hidden');
                    profileModal.classList.remove('flex');
                }
            });
        }

        if (roommateProfileForm) {
            roommateProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = roommateProfileForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

                const formData = new FormData(roommateProfileForm);
                const data = Object.fromEntries(formData.entries());
                
                // Get user_type from the hidden input
                data.user_type = userTypeHiddenInput.value;

                // Conditionally collect and clean data based on user_type
                if (data.user_type === 'looking_for_room') {
                    data.age = data.age ? parseInt(data.age) : null;
                    data.budget = data.budget ? parseInt(data.budget) : null;
                    // lifestyle_preferences is already handled by updateHiddenInput
                    data.num_available_rooms = null;
                    data.rent_amount_offering = null;
                    data.room_size = '';
                    data.house_rules = '';
                    data.availability_date = '';
                    data.property_photos = '';
                    data.furnished = ''; // Clear
                    data.bills_included = ''; // Clear
                } else if (data.user_type === 'offering_room') {
                    data.num_available_rooms = data.num_available_rooms ? parseInt(data.num_available_rooms) : null;
                    data.rent_amount_offering = data.rent_amount_offering ? parseFloat(data.rent_amount_offering) : null;
                    // house_rules is already handled by updateHiddenInput
                    data.age = null;
                    data.gender = '';
                    data.sleep_schedule = '';
                    data.cleanliness = '';
                    data.lifestyle_preferences = '';
                    data.furnished = furnishedSelect.value; // NEW
                    data.bills_included = billsIncludedSelect.value; // NEW
                    data.property_photos = propertyPhotosTextarea.value.trim(); // NEW
                }

                try {
                    const response = await fetch(window.API_SAVE_ROOMMATE_PROFILE_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showToast(result.message, 'success');
                        if (profileModal) {
                            profileModal.classList.add('hidden');
                            profileModal.classList.remove('flex');
                        }
                        location.reload(); // Reload to update profile info on dashboard
                    } else {
                        showToast(result.message || 'Failed to save profile.', 'error');
                        if (profileModal) {
                            profileModal.classList.remove('hidden');
                            profileModal.classList.add('flex');
                        }
                    }
                } catch (error) {
                    console.error('Network error:', error);
                    showToast('Network error. Please try again.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Profile';
                }
            });
        }


        // --- Roommate Match Finder Logic (Swipe UI) ---
        const findMatchesBtn = document.getElementById('find-matches-btn');
        const roommateMatchesLoader = document.getElementById('roommate-matches-loader');
        const roommateMatchCardDisplay = document.getElementById('roommate-match-card-display');
        const roommatePrompt = document.getElementById('roommate-prompt');
        const noMoreMatchesPrompt = document.getElementById('no-more-matches-prompt');
        const resetMatchesBtn = document.getElementById('reset-matches-btn');
        const swipeButtonsContainer = document.getElementById('swipe-buttons-container');
        const skipMatchBtn = document.getElementById('skip-match-btn');
        const likeMatchBtn = document.getElementById('like-match-btn');
        const findMatchesBtnInner = document.getElementById('find-matches-btn-inner');

        let currentMatches = [];
        let currentMatchIndex = 0;
        
        // Swipe variables
        let startX = 0;
        let currentX = 0;
        let isSwiping = false;
        const swipeThreshold = 75; // Pixels to swipe to trigger action

        function displayCurrentMatch() {
            if (!roommateMatchCardDisplay || !roommatePrompt || !noMoreMatchesPrompt || !swipeButtonsContainer) return;

            // Clear previous content and reset styles
            roommateMatchCardDisplay.innerHTML = '';
            roommatePrompt.classList.add('hidden');
            noMoreMatchesPrompt.classList.add('hidden');

            // Display 5 to 8 profiles at a time
            const profilesToShow = Math.min(currentMatches.length - currentMatchIndex, Math.floor(Math.random() * 4) + 5);
            
            if (profilesToShow > 0) {
                for (let i = 0; i < profilesToShow; i++) {
                    const match = currentMatches[currentMatchIndex + i];
                    if (!match) break; // Ensure we don't go out of bounds

                    // Safely access properties, providing defaults for undefined/null
                    const name = (match.name && match.name !== 'undefined') ? match.name : 'Unknown User';
                    const location = (match.location && match.location !== 'undefined') ? match.location : 'N/A';
                    const compatibilityScore = (match.compatibility_score !== undefined && match.compatibility_score !== null) ? `${match.compatibility_score}` : 'N/A';
                    const bio = (match.bio && match.bio !== 'undefined') ? match.bio : 'No bio provided for this user.';
                    const avatarUrl = (match.avatar_url && match.avatar_url !== 'undefined') ? match.avatar_url : 'https://placehold.co/110x110/cccccc/ffffff?text=User';

                    let matchDetailsHtml = '';
                    let aiBadge = '';
                    let isAIMatch = match.uid && match.uid.startsWith('ai_profile_');

                    if (isAIMatch) {
                        aiBadge = '<span class="ai-demo-badge">Verified AI Demo</span>';
                    }

                    if (match.user_type === 'looking_for_room') {
                        const age = (match.age !== undefined && match.age !== null) ? `${match.age}` : 'N/A';
                        const gender = (match.gender && match.gender !== 'undefined') ? match.gender : 'N/A';
                        const budget = (match.budget !== undefined && match.budget !== null) ? `£${match.budget}` : 'N/A';
                        matchDetailsHtml = `
                            <h4 class="text-3xl font-bold text-gray-900 mb-2">${name}, ${age}</h4>
                            <p class="text-lg text-gray-600 mb-2">${location} | ${gender}</p>
                            <p class="text-md text-gray-600 mb-2">Budget: ${budget}</p>
                        `;
                    } else if (match.user_type === 'offering_room') {
                        const rent = (match.rent_amount_offering !== undefined && match.rent_amount_offering !== null) ? `£${match.rent_amount_offering}` : 'N/A';
                        const rooms = (match.num_available_rooms !== undefined && match.num_available_rooms !== null) ? `${match.num_available_rooms} room(s)` : 'N/A';
                        const roomSize = (match.room_size && match.room_size !== 'undefined') ? match.room_size : 'N/A';
                        const availabilityDate = (match.availability_date && match.availability_date !== 'undefined') ? new Date(match.availability_date).toLocaleDateString() : 'N/A';
                        const furnished = (match.furnished && match.furnished !== 'undefined') ? match.furnished : 'N/A';
                        const billsIncluded = (match.bills_included && match.bills_included !== 'undefined') ? match.bills_included : 'N/A';
                        matchDetailsHtml = `
                            <h4 class="text-3xl font-bold text-gray-900 mb-2">${name} (Offering Room)</h4>
                            <p class="text-lg text-gray-600 mb-2">${location} | ${rooms}</p>
                            <p class="text-md text-gray-600 mb-2">Rent: ${rent} | Size: ${roomSize}</p>
                            <p class="text-md text-gray-600 mb-2">Available: ${availabilityDate} | Furnished: ${furnished} | Bills: ${billsIncluded}</p>
                        `;
                    }

                    const matchCard = document.createElement('div');
                    matchCard.className = 'roommate-match-card glass-card';
                    matchCard.innerHTML = `
                        ${aiBadge}
                        <img src="${avatarUrl}" alt="${name}" class="mx-auto mb-4 w-28 h-28 rounded-full object-cover border-4 border-blue-400" onerror="this.onerror=null;this.src='https://placehold.co/110x110/cccccc/ffffff?text=User'">
                        ${matchDetailsHtml}
                        <div class="compatibility-score">${compatibilityScore}% Match</div>
                        <button class="match-details-btn btn-secondary mt-4 btn-hover-effect" data-match='${JSON.stringify(match)}' data-user-type='${match.user_type}' ${isAIMatch ? 'disabled' : ''}>View Details</button>
                    `;
                    // Position cards in a stack, slightly offset
                    matchCard.style.setProperty('--card-offset-y', `${i * -10}px`);
                    matchCard.style.setProperty('--card-scale', `${1 - i * 0.02}`);
                    matchCard.style.setProperty('--card-rotate-z', `${i * (Math.random() > 0.5 ? 1 : -1) * 2}deg`); /* Slight random rotation */
                    matchCard.style.zIndex = currentMatches.length - (currentMatchIndex + i);

                    roommateMatchCardDisplay.appendChild(matchCard);

                    // Add swipe event listeners only to the top-most card
                    if (i === 0) {
                        addSwipeListeners(matchCard);
                        swipeButtonsContainer.classList.remove('hidden');
                        if (isAIMatch) { // Disable swipe buttons for AI profiles
                            skipMatchBtn.disabled = true;
                            likeMatchBtn.disabled = true;
                        } else {
                            skipMatchBtn.disabled = false;
                            likeMatchBtn.disabled = false;
                        }
                    }

                    matchCard.querySelector('.match-details-btn').addEventListener('click', (e) => {
                        const matchData = JSON.parse(e.target.dataset.match);
                        const profileUserType = matchData.user_type; // Use matchData.user_type
                        displayActivityDetails('Liked Profile', matchData, null, matchData.uid || null, profileUserType);
                    });
                }
            } else {
                roommateMatchCardDisplay.innerHTML = '';
                swipeButtonsContainer.classList.add('hidden');
                noMoreMatchesPrompt.classList.remove('hidden');
            }
        }

        // NEW: Swipe event listeners function (unified for mouse and touch)
        function addSwipeListeners(cardElement) {
            let initialX = 0;
            let currentX = 0;
            let isDragging = false;

            const startDrag = (clientX) => {
                initialX = clientX;
                isDragging = true;
                cardElement.style.transition = 'none'; // Disable transition during drag
            };

            const dragMove = (clientX) => {
                if (!isDragging) return;
                currentX = clientX;
                const diffX = currentX - initialX;
                // Apply the offset and scale from stacking, then add swipe transform
                const offsetY = parseFloat(cardElement.style.getPropertyValue('--card-offset-y') || '0px');
                const scale = parseFloat(cardElement.style.getPropertyValue('--card-scale') || '1');
                const rotateZ = parseFloat(cardElement.style.getPropertyValue('--card-rotate-z') || '0deg');

                cardElement.style.transform = `translate(-50%, -50%) translateY(${offsetY}px) scale(${scale}) translateX(${diffX}px) rotate(${rotateZ + (diffX / 20)}deg)`;
            };

            const endDrag = () => {
                if (!isDragging) return;
                isDragging = false;
                const diffX = currentX - initialX;
                cardElement.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out'; // Re-enable transition

                if (diffX > swipeThreshold) {
                    animateAndAdvance('like');
                } else if (diffX < -swipeThreshold) {
                    animateAndAdvance('skip');
                } else {
                    // Reset to original stacked position
                    const offsetY = parseFloat(cardElement.style.getPropertyValue('--card-offset-y') || '0px');
                    const scale = parseFloat(cardElement.style.getPropertyValue('--card-scale') || '1');
                    const rotateZ = parseFloat(cardElement.style.getPropertyValue('--card-rotate-z') || '0deg');
                    cardElement.style.transform = `translate(-50%, -50%) translateY(${offsetY}px) scale(${scale}) translateX(0) rotate(${rotateZ}deg)`;
                }
            };

            // Mouse events
            cardElement.addEventListener('mousedown', (e) => startDrag(e.clientX));
            cardElement.addEventListener('mousemove', (e) => dragMove(e.clientX));
            cardElement.addEventListener('mouseup', endDrag);
            cardElement.addEventListener('mouseleave', () => { // End drag if mouse leaves card area
                if (isDragging) endDrag();
            });

            // Touch events
            cardElement.addEventListener('touchstart', (e) => startDrag(e.touches[0].clientX));
            cardElement.addEventListener('touchmove', (e) => dragMove(e.touches[0].clientX));
            cardElement.addEventListener('touchend', endDrag);
        }

        async function fetchRoommateMatches() {
            if (!roommatePrompt || !noMoreMatchesPrompt || !roommateMatchesLoader || !roommateMatchCardDisplay || !swipeButtonsContainer) return;

            if (!window.currentUserId || window.currentUserId === 'null' || !window.currentUserProfileType || window.currentUserProfileType === 'null') {
                showToast("Please complete your profile and select your role (Looking for a Room / Offering a Room) to find matches.", "error");
                roommatePrompt.classList.remove('hidden');
                return;
            }

            roommatePrompt.classList.add('hidden');
            noMoreMatchesPrompt.classList.add('hidden');
            roommateMatchesLoader.classList.remove('hidden');
            roommateMatchCardDisplay.innerHTML = '';
            swipeButtonsContainer.classList.add('hidden');

            try {
                // Fetch matches from Django backend (which now handles AI generation)
                const response = await fetch(window.API_FIND_ROOMMATE_MATCHES_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({})
                });
                const data = await response.json();

                roommateMatchesLoader.classList.add('hidden');

                if (data.status === 'success' && data.data && data.data.matches) {
                    currentMatches = data.data.matches;
                    currentMatchIndex = 0;
                    if (currentMatches.length > 0) {
                        displayCurrentMatch();
                    } else {
                        noMoreMatchesPrompt.classList.remove('hidden');
                    }
                } else {
                    showToast(data.message || 'Failed to find matches.', 'error');
                    roommatePrompt.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Network error fetching roommate matches:', error);
                roommateMatchesLoader.classList.add('hidden');
                showToast('Network error finding matches. Please check your internet connection or try again later.', 'error');
                roommatePrompt.classList.remove('hidden');
            }
        }

        async function animateAndAdvance(direction) {
            const currentCard = roommateMatchCardDisplay.querySelector('.roommate-match-card');
            if (currentCard) {
                currentCard.style.transition = 'transform 0.5s ease-out, opacity 0.5s ease-out'; // Ensure animation
                const currentMatchData = currentMatches[currentMatchIndex];
                const isAIMatch = currentMatchData.uid && currentMatchData.uid.startsWith('ai_profile_');

                if (direction === 'like') {
                    if (isAIMatch) {
                        showToast("Cannot like AI demo profiles.", "info");
                        // Reset card position if it's an AI profile and tried to like
                        const offsetY = parseFloat(currentCard.style.getPropertyValue('--card-offset-y') || '0px');
                        const scale = parseFloat(currentCard.style.getPropertyValue('--card-scale') || '1');
                        const rotateZ = parseFloat(currentCard.style.getPropertyValue('--card-rotate-z') || '0deg');
                        currentCard.style.transform = `translate(-50%, -50%) translateY(${offsetY}px) scale(${scale}) translateX(0) rotate(${rotateZ}deg)`;
                        return; // Do not advance if it's an AI profile
                    }

                    const dataToSend = {
                        name: currentMatchData.name || '',
                        age: currentMatchData.age !== undefined && currentMatchData.age !== null ? parseInt(currentMatchData.age) : null,
                        gender: currentMatchData.gender || '',
                        location: currentMatchData.location || '',
                        budget: currentMatchData.budget !== undefined && currentMatchData.budget !== null ? parseInt(currentMatchData.budget) : null,
                        bio: currentMatchData.bio || '',
                        compatibility_score: currentMatchData.compatibility_score !== undefined && currentMatchData.compatibility_score !== null ? parseInt(currentMatchData.compatibility_score) : null,
                        avatar_url: currentMatchData.avatar_url || '',
                        uid: currentMatchData.uid || '',
                        user_type: currentMatchData.user_type || '', // Pass user_type
                        num_available_rooms: currentMatchData.num_available_rooms !== undefined && currentMatchData.num_available_rooms !== null ? parseInt(currentMatchData.num_available_rooms) : null,
                        rent_amount_offering: currentMatchData.rent_amount_offering !== undefined && currentMatchData.rent_amount_offering !== null ? parseFloat(currentMatchData.rent_amount_offering) : null,
                        room_size: currentMatchData.room_size || '',
                        house_rules: currentMatchData.house_rules || '',
                        availability_date: currentMatchData.availability_date || '',
                        furnished: currentMatchData.furnished || '',
                        bills_included: currentMatchData.bills_included || '',
                    };

                    try {
                        const saveResponse = await fetch(window.API_SAVE_LIKED_PROFILE_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify(dataToSend)
                        });
                        const saveResult = await saveResponse.json();
                        if (saveResult.status === 'success' || saveResult.status === 'info') {
                            showToast(saveResult.message, saveResult.status);
                            currentCard.classList.add('swiping-right');
                            currentCard.addEventListener('transitionend', () => {
                                currentCard.remove(); // Remove the swiped card
                                currentMatchIndex++;
                                displayCurrentMatch(); // Display the next set of cards
                                // After liking, if it's a real user, prompt for chat request
                                if (currentMatchData.uid && !currentMatchData.uid.startsWith('ai_profile_')) {
                                    showChatRequestConfirmModal(currentMatchData.uid, currentMatchData.name);
                                }
                            }, { once: true });
                            fetchNotifications();
                        } else {
                            showToast(saveResult.message || 'Failed to save liked profile.', 'error');
                            console.error('Error saving liked profile:', saveResult.errors);
                            // If saving fails, reset the card position
                            const offsetY = parseFloat(currentCard.style.getPropertyValue('--card-offset-y') || '0px');
                            const scale = parseFloat(currentCard.style.getPropertyValue('--card-scale') || '1');
                            const rotateZ = parseFloat(currentCard.style.getPropertyValue('--card-rotate-z') || '0deg');
                            currentCard.style.transform = `translate(-50%, -50%) translateY(${offsetY}px) scale(${scale}) translateX(0) rotate(${rotateZ}deg)`;
                        }
                    } catch (error) {
                        console.error('Network error saving liked profile:', error);
                        showToast('Network error saving liked profile. Please try again.', 'error');
                        // Reset on network error
                        const offsetY = parseFloat(currentCard.style.getPropertyValue('--card-offset-y') || '0px');
                        const scale = parseFloat(currentCard.style.getPropertyValue('--card-scale') || '1');
                        const rotateZ = parseFloat(currentCard.style.getPropertyValue('--card-rotate-z') || '0deg');
                        currentCard.style.transform = `translate(-50%, -50%) translateY(${offsetY}px) scale(${scale}) translateX(0) rotate(${rotateZ}deg)`;
                    }
                } else { // If skipping
                    currentCard.classList.add('swiping-left');
                    currentCard.addEventListener('transitionend', () => {
                        currentCard.remove(); // Remove the swiped card
                        currentMatchIndex++;
                        displayCurrentMatch(); // Display the next set of cards
                    }, { once: true });
                }
            }
        }

        // Only add event listener if the button exists (it's inside a conditional Django block)
        if (findMatchesBtn) {
            findMatchesBtn.addEventListener('click', fetchRoommateMatches);
        }

        if (findMatchesBtnInner) {
            findMatchesBtnInner.addEventListener('click', fetchRoommateMatches);
        }

        if (resetMatchesBtn) {
            resetMatchesBtn.addEventListener('click', fetchRoommateMatches);
        }

        if (skipMatchBtn) {
            skipMatchBtn.addEventListener('click', () => animateAndAdvance('skip'));
        }

        if (likeMatchBtn) {
            likeMatchBtn.addEventListener('click', () => animateAndAdvance('like'));
        }

        // --- Generic Activity/Service Details Modal Logic ---
        const activityDetailsModal = document.getElementById('activity-details-modal');
        const closeActivityModalBtn = document.getElementById('close-activity-modal-btn');
        const activityModalContent = document.getElementById('activity-modal-content');
        const modalRedirectBtn = document.getElementById('modal-redirect-btn');
        const modalStartChatBtn = document.getElementById('modal-start-chat-btn');

        function displayActivityDetails(activityType, details, redirectUrl = null, chatUid = null, profileUserType = null) {
            if (!activityModalContent || !activityDetailsModal) return;

            activityModalContent.innerHTML = '';
            let contentHtml = `<h3 class="text-2xl font-bold text-gray-900 mb-4">${activityType} Details</h3>`;

            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                try {
                    return new Date(dateString).toLocaleString();
                } catch (e) {
                    return dateString;
                }
            };

            const formatCurrency = (value) => {
                if (value === null || value === undefined || isNaN(parseFloat(value))) return 'N/A';
                return `£${parseFloat(value).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            };

            if (activityType === 'Liked Profile') {
                contentHtml += `
                    <img src="${details.avatar_url || 'https://placehold.co/112x112/cccccc/ffffff?text=User'}" alt="${details.name || 'User'}" class="mx-auto mb-4 w-28 h-28 rounded-full object-cover border-4 border-blue-400" onerror="this.onerror=null;this.src='https://placehold.co/112x112/cccccc/ffffff?text=User'">
                    <h4 class="text-xl font-bold text-gray-900 mb-2">${details.name || 'Unknown User'}</h4>
                    <p class="text-md text-gray-700 mb-4">Location: ${details.location || 'N/A'}</p>
                    <div class="text-left space-y-3">
                        <div class="detail-item"><i class="fas fa-user-friends"></i><span class="font-semibold">Compatibility:</span> <span class="compatibility-score-modal">${details.compatibility_score || 'N/A'}%</span></div>
                `;
                
                if (profileUserType === 'looking_for_room') {
                    contentHtml += `
                        <div class="detail-item"><i class="fas fa-venus-mars"></i><span class="font-semibold">Gender:</span> ${details.gender || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-money-bill-wave"></i><span class="font-semibold">Budget:</span> ${formatCurrency(details.budget)} / month</div>
                        <div class="detail-item"><i class="fas fa-calendar-alt"></i><span class="font-semibold">Age:</span> ${details.age || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-info-circle"></i><span class="font-semibold">Bio:</span> <p class="whitespace-pre-wrap">${details.bio || 'No bio provided for this user.'}</p></div>
                    `;
                } else if (profileUserType === 'offering_room') {
                    contentHtml += `
                        <div class="detail-item"><i class="fas fa-door-open"></i><span class="font-semibold">Available Rooms:</span> ${details.num_available_rooms || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-money-bill-wave"></i><span class="font-semibold">Rent:</span> ${formatCurrency(details.rent_amount_offering)} / month</div>
                        <div class="detail-item"><i class="fas fa-expand-arrows-alt"></i><span class="font-semibold">Room Size:</span> ${details.room_size || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-calendar-alt"></i><span class="font-semibold">Available From:</span> ${formatDate(details.availability_date)}</div>
                        <div class="detail-item"><i class="fas fa-gavel"></i><span class="font-semibold">House Rules:</span> ${details.house_rules || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-info-circle"></i><span class="font-semibold">Bio:</span> <p class="whitespace-pre-wrap">${details.bio || 'No bio provided for this user.'}</p></div>
                        <div class="detail-item"><i class="fas fa-couch"></i><span class="font-semibold">Furnished:</span> ${details.furnished || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-file-invoice-dollar"></i><span class="font-semibold">Bills Included:</span> ${details.bills_included || 'N/A'}</div>
                        {% comment %} Display property photos if available {% endcomment %}
                        <div class="detail-item"><i class="fas fa-images"></i><span class="font-semibold">Photos:</span></div>
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${details.property_photos && details.property_photos.split(',').length > 0 ? 
                                details.property_photos.split(',').map(url => `<img src="${url.trim()}" class="w-24 h-24 object-cover rounded-md shadow-sm" onerror="this.onerror=null;this.src='https://placehold.co/96x96/cccccc/ffffff?text=No+Image'">`).join('')
                                : '<p>No photos available.</p>'
                            }
                        </div>
                    `;
                }
                contentHtml += `</div>`;
                chatPartnerUid = chatUid;
                chatPartnerName = details.name || 'Unknown User';
            } else if (activityType === 'Rent Check') {
                contentHtml += `
                    <div class="text-left space-y-3">
                        <div class="detail-item"><i class="fas fa-map-marker-alt"></i><span class="font-semibold">Postcode:</span> ${details.postcode || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-bed"></i><span class="font-semibold">Bedrooms:</span> ${details.bedrooms || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-gbp-sign"></i><span class="font-semibold">Estimated Rent:</span> ${formatCurrency(details.estimated_rent)} / month</div>
                        <div class="detail-item"><i class="fas fa-calendar-alt"></i><span class="font-semibold">Checked At:</span> ${formatDate(details.checked_at)}</div>
                    </div>
                `;
            } else if (activityType === 'Review') {
                contentHtml += `
                    <div class="text-left space-y-3">
                        <div class="detail-item"><i class="fas fa-user-tie"></i><span class="font-semibold">Landlord:</span> ${details.landlord_name || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-map-marker-alt"></i><span class="font-semibold">Property:</span> ${details.property_address || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-star"></i><span class="font-semibold">Rating:</span> ${details.rating || 'N/A'} Stars</div>
                        <div class="detail-item"><i class="fas fa-comment-alt"></i><span class="font-semibold">Comments:</span> <p class="whitespace-pre-wrap">${details.comments || 'No comments provided.'}</p></div>
                        <div class="detail-item"><i class="fas fa-calendar-alt"></i><span class="font-semibold">Reviewed At:</span> ${formatDate(details.reviewed_at)}</div>
                        <div class="detail-item"><i class="fas fa-user"></i><span class="font-semibold">Reviewer:</span> ${details.reviewer || 'N/A'}</div>
                    </div>
                `;
            } else if (activityType === 'Complaint') {
                contentHtml += `
                    <div class="text-left space-y-3">
                        <div class="detail-item"><i class="fas fa-exclamation-triangle"></i><span class="font-semibold">Issue Type:</span> ${details.issue_type || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-map-marker-alt"></i><span class="font-semibold">Property:</span> ${details.property_address || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-user-tie"></i><span class="font-semibold">Landlord (Optional):</span> ${details.landlord_name || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-file-alt"></i><span class="font-semibold">Description:</span> <p class="whitespace-pre-wrap">${details.description || 'No description provided.'}</p></div>
                        <div class="detail-item"><i class="fas fa-info-circle"></i><span class="font-semibold">Status:</span> ${details.status || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-calendar-alt"></i><span class="font-semibold">Submitted At:</span> ${formatDate(details.submitted_at)}</div>
                    </div>
                `;
            } else if (activityType === 'Forum Post') {
                contentHtml += `
                    <div class="text-left space-y-3">
                        <div class="detail-item"><i class="fas fa-heading"></i><span class="font-semibold">Title:</span> ${details.title || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-tags"></i><span class="font-semibold">Category:</span> ${details.category || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-file-alt"></i><span class="font-semibold">Content:</span> <p class="whitespace-pre-wrap">${details.content || 'No content provided.'}</p></div>
                        <div class="detail-item"><i class="fas fa-calendar-alt"></i><span class="font-semibold">Posted At:</span> ${formatDate(details.created_at)}</div>
                        <div class="detail-item"><i class="fas fa-user"></i><span class="font-semibold">Author:</span> ${details.author || 'N/A'}</div>
                    </div>
                `;
            } else if (activityType === 'Contract Analysis') {
                contentHtml += `
                    <div class="text-left space-y-3">
                        <div class="detail-item"><i class="fas fa-calendar-alt"></i><span class="font-semibold">Analyzed At:</span> ${formatDate(details.analyzed_at)}</div>
                        <div class="detail-item"><i class="fas fa-file-alt"></i><span class="font-semibold">Original Text:</span> <p class="whitespace-pre-wrap text-sm max-h-40 overflow-y-auto border p-2 rounded">${details.original_text || 'No original text provided.'}</p></div>
                        <div class="detail-item"><i class="fas fa-robot"></i><span class="font-semibold">AI Analysis:</span> <p class="whitespace-pre-wrap">${details.analysis_result || 'No detailed analysis available.'}</p></div>
                    </div>
                `;
            } else if (activityType === 'Rent Declaration Check') {
                contentHtml += `
                    <div class="text-left space-y-3">
                        <div class="detail-item"><i class="fas fa-map-marker-alt"></i><span class="font-semibold">Postcode:</span> ${details.postcode || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-bed"></i><span class="font-semibold">Bedrooms:</span> ${details.bedrooms || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-pound-sign"></i><span class="font-semibold">Actual Rent Paid:</span> ${formatCurrency(details.actual_rent_paid)} / month</div>
                        <div class="detail-item"><i class="fas fa-city"></i><span class="font-semibold">Council Tax Band:</span> ${details.council_tax_band || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-calculator"></i><span class="font-semibold">Estimated Council Tax:</span> ${formatCurrency(details.estimated_council_tax)}</div>
                        <div class="detail-item"><i class="fas fa-exclamation-circle"></i><span class="font-semibold">Discrepancy Found:</span> <span class="${details.discrepancy_found ? 'text-red-600 font-bold' : 'text-green-600 font-bold'}">${details.discrepancy_found ? 'Yes' : 'No'}</span></div>
                        <div class="detail-item"><i class="fas fa-robot"></i><span class="font-semibold">AI Analysis:</span> <p class="whitespace-pre-wrap">${details.analysis_result || 'No detailed analysis available.'}</p></div>
                        <div class="detail-item"><i class="fas fa-calendar-alt"></i><span class="font-semibold">Checked At:</span> ${formatDate(details.checked_at)}</div>
                    </div>
                `;
            }
            else {
                contentHtml += `<p class="text-center text-gray-500">Details for this activity type are not available.</p>`;
            }

            activityModalContent.innerHTML = contentHtml;
            
            if (redirectUrl) {
                modalRedirectBtn.href = redirectUrl;
                modalRedirectBtn.classList.remove('hidden');
            } else {
                modalRedirectBtn.classList.add('hidden');
            }

            // Only show chat button if it's a liked profile, it's a real user, and not the current user
            if (activityType === 'Liked Profile' && chatUid && window.currentUserId && chatUid !== 'null' && chatUid !== window.currentUserId && !chatUid.startsWith('ai_profile_')) {
                modalStartChatBtn.classList.remove('hidden');
            } else {
                modalStartChatBtn.classList.add('hidden');
            }

            activityDetailsModal.classList.remove('hidden');
            activityDetailsModal.classList.add('flex');
        }

        if (closeActivityModalBtn) {
            closeActivityModalBtn.addEventListener('click', () => {
                activityDetailsModal.classList.add('hidden');
                activityDetailsModal.classList.remove('flex');
                chatPartnerUid = null;
                chatPartnerName = '';
            });
        }

        document.addEventListener('click', (event) => {
            const activityItem = event.target.closest('.activity-item[data-activity-details-id]');
            const serviceResultCard = event.target.closest('.service-result-card[data-service-details-id]');

            if (activityItem) {
                const activityType = activityItem.dataset.activityType;
                const scriptId = activityItem.dataset.activityDetailsId;
                const redirectUrl = activityItem.dataset.redirectUrl || null;
                const scriptTag = document.getElementById(scriptId);
                let details;

                if (scriptTag) {
                    try {
                        // Correctly parse JSON from the script tag's text content
                        details = JSON.parse(scriptTag.textContent);
                        const chatUid = (activityType === 'Liked Profile' && details.uid) ? details.uid : null;
                        const profileUserType = (activityType === 'Liked Profile' && details.user_type) ? details.user_type : null;
                        displayActivityDetails(activityType, details, redirectUrl, chatUid, profileUserType);
                    } catch (e) {
                        console.error('Error parsing JSON from activity script tag:', e, scriptTag.textContent);
                        showToast('Error loading activity details (parse error).', 'error');
                        return;
                    }
                } else {
                    console.warn('Activity script tag not found for ID:', scriptId);
                    showToast('Error loading activity details (script tag missing).', 'error');
                    return;
                }
            } else if (serviceResultCard) {
                const activityType = serviceResultCard.dataset.activityType;
                const scriptId = serviceResultCard.dataset.serviceDetailsId;
                const scriptTag = document.getElementById(scriptId);
                let details;

                if (scriptTag) {
                    try {
                        // Correctly parse JSON from the script tag's text content
                        details = JSON.parse(scriptTag.textContent);
                        const chatUid = (activityType === 'Liked Profile' && details.uid) ? details.uid : null;
                        const profileUserType = (activityType === 'Liked Profile' && details.user_type) ? details.user_type : null;
                        displayActivityDetails(activityType, details, null, chatUid, profileUserType);
                    } catch (e) {
                        console.error('Error parsing JSON from service result script tag:', e, scriptTag.textContent);
                        showToast('Error loading service result details (parse error).', 'error');
                        return;
                    }
                } else {
                    console.warn('Service result script tag not found for ID:', scriptId);
                    showToast('Error loading service result details (script tag missing).', 'error');
                    return;
                }
            }
        });

        // Tab switching logic for My Services section
        document.addEventListener('DOMContentLoaded', () => {
            const mainContentTabButtons = document.querySelectorAll('#my-services-section .main-content-tab-button');
            const mainContentTabContents = document.querySelectorAll('.main-content-tab-content');

            mainContentTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTabId = button.dataset.tabId;

                    mainContentTabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    mainContentTabContents.forEach(content => {
                        if (content.id === targetTabId) {
                            content.classList.remove('hidden');
                        } else {
                            content.classList.add('hidden');
                        }
                    });
                });
            });
        });


        // --- Chat Functionality (Django Polling) ---
        const chatModal = document.getElementById('chat-modal');
        const closeChatModalBtn = document.getElementById('close-chat-modal-btn');
        const chatPartnerNameSpan = document.getElementById('chat-partner-name');
        const chatMessagesDiv = document.getElementById('chat-messages');
        const chatMessageInput = document.getElementById('chat-message-input');
        const sendChatMessageBtn = document.getElementById('send-chat-message-btn');

        // NEW: Chat Request Confirmation Modal elements
        const chatRequestConfirmModal = document.getElementById('chat-request-confirm-modal');
        const confirmChatPartnerNameSpan = document.getElementById('confirm-chat-partner-name');
        const cancelChatRequestBtn = document.getElementById('cancel-chat-request-btn');
        const sendChatRequestBtn = document.getElementById('send-chat-request-btn');

        let currentLikedUserUidForChat = null; // Store UID for chat request

        async function fetchMessages() {
            if (!window.currentUserId || window.currentUserId === 'null') {
                console.warn("Cannot fetch messages: currentUserId or chatPartnerUid is missing.");
                return;
            }
            try {
                // Ensure the URL is correctly formed by appending the UID
                const url = `${window.API_GET_CHAT_MESSAGES_BASE_URL}${chatPartnerUid}/`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.status === 'success') {
                    chatMessagesDiv.innerHTML = '';
                    if (data.messages.length === 0) {
                        chatMessagesDiv.innerHTML = '<div class="text-center text-gray-500">No messages yet. Say hello!</div>';
                    }
                    data.messages.forEach(msg => {
                        const messageElement = document.createElement('div');
                        messageElement.className = `chat-message ${msg.sender_uid === window.currentUserId ? 'sent' : 'received'}`;
                        
                        const timestampSpan = document.createElement('span');
                        timestampSpan.className = 'text-xs text-gray-500 ml-2';
                        if (msg.timestamp) {
                            const date = new Date(msg.timestamp);
                            timestampSpan.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        }

                        const messageTextSpan = document.createElement('span');
                        messageTextSpan.textContent = msg.message;

                        messageElement.appendChild(messageTextSpan);
                        messageElement.appendChild(timestampSpan);

                        chatMessagesDiv.appendChild(messageElement);
                    });
                    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                } else {
                    showToast(data.message || 'Failed to load messages.', 'error');
                }
            } catch (error) {
                console.error('Error fetching messages:', error);
                showToast('Network error fetching messages.', 'error');
            }
        }

        function openChat(targetUid, targetName) {
            if (!window.currentUserId || window.currentUserId === 'null') {
                showToast("You must be logged in to chat.", "error");
                return;
            }
            // Prevent chat with AI profiles
            if (targetUid.startsWith('ai_profile_')) {
                showToast("Cannot chat with AI demo profiles.", "info");
                return;
            }

            chatPartnerUid = targetUid;
            chatPartnerName = targetName;
            chatPartnerNameSpan.textContent = targetName;
            chatModal.classList.remove('hidden');
            chatModal.classList.add('flex');
            chatMessagesDiv.innerHTML = '<div class="text-center text-gray-500">Loading messages...</div>';

            if (chatPollingInterval) {
                clearInterval(chatPollingInterval);
            }
            chatPollingInterval = setInterval(fetchMessages, 2000); // Poll every 2 seconds
            fetchMessages();
        }

        function closeChat() {
            chatModal.classList.add('hidden');
            chatModal.classList.remove('flex');
            if (chatPollingInterval) {
                clearInterval(chatPollingInterval);
                chatPollingInterval = null;
            }
            chatMessagesDiv.innerHTML = '';
            chatMessageInput.value = '';
            chatPartnerUid = null;
            chatPartnerName = '';
        }

        async function sendMessage() {
            if (!window.currentUserId || window.currentUserId === 'null') {
                showToast("You must be logged in to send messages.", "error");
                return;
            }
            if (!chatPartnerUid) {
                showToast("No chat partner selected.", "error");
                return;
            }
            if (chatPartnerUid.startsWith('ai_profile_')) { // Double check to prevent sending messages to AI
                showToast("Cannot send messages to AI demo profiles.", "info");
                chatMessageInput.value = '';
                return;
            }

            const messageText = chatMessageInput.value.trim();
            if (messageText === '') {
                return;
            }

            try {
                const response = await fetch(window.API_SEND_CHAT_MESSAGE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        receiver_uid: chatPartnerUid,
                        message: messageText
                    })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    chatMessageInput.value = '';
                    fetchMessages();
                    fetchNotifications();
                } else {
                    showToast(result.message || 'Failed to send message.', 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Network error sending message. Please try again.', 'error');
            }
        }

        if (modalStartChatBtn) {
            modalStartChatBtn.addEventListener('click', () => {
                if (chatPartnerUid && chatPartnerName) {
                    closeActivityModalBtn.click();
                    openChat(chatPartnerUid, chatPartnerName);
                } else {
                    showToast("Could not start chat. Partner details missing.", "error");
                }
            });
        }

        if (closeChatModalBtn) {
            closeChatModalBtn.addEventListener('click', closeChat);
        }

        if (sendChatMessageBtn) {
            sendChatMessageBtn.addEventListener('click', sendMessage);
            chatMessageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        // --- NEW: Chat Request Confirmation Modal Logic ---
        function showChatRequestConfirmModal(uid, name) {
            if (uid.startsWith('ai_profile_')) { // Do not show confirm modal for AI profiles
                return;
            }
            currentLikedUserUidForChat = uid;
            confirmChatPartnerNameSpan.textContent = name;
            chatRequestConfirmModal.classList.remove('hidden');
            chatRequestConfirmModal.classList.add('flex');
        }

        function closeChatRequestConfirmModal() {
            chatRequestConfirmModal.classList.add('hidden');
            chatRequestConfirmModal.classList.remove('flex');
            currentLikedUserUidForChat = null;
        }

        if (cancelChatRequestBtn) {
            cancelChatRequestBtn.addEventListener('click', closeChatRequestConfirmModal);
        }

        if (sendChatRequestBtn) {
            sendChatRequestBtn.addEventListener('click', async () => {
                if (!currentLikedUserUidForChat) return;

                // In a real app, this would send a request to the backend,
                // and the chat would only open if the recipient accepts.
                // For this demo, we simulate immediate acceptance.
                showToast(`Chat request sent to ${confirmChatPartnerNameSpan.textContent}!`, 'success');
                closeChatRequestConfirmModal();
                openChat(currentLikedUserUidForChat, confirmChatPartnerNameSpan.textContent);
            });
        }


        // --- Notification System Logic ---
        const notificationBellBtn = document.getElementById('notification-bell-btn');
        const notificationBadge = document.getElementById('notification-badge');
        const notificationModal = document.getElementById('notification-modal');
        const notificationList = document.getElementById('notification-list');
        const noNotificationsMessage = document.getElementById('no-notifications-message');
        const markAllReadBtn = document.getElementById('mark-all-read-btn');

        if (notificationBellBtn) {
            notificationBellBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                notificationModal.classList.toggle('active');
                if (notificationModal.classList.contains('active')) {
                    fetchNotifications();
                }
            });
        }

        document.addEventListener('click', (event) => {
            if (notificationModal && !notificationModal.contains(event.target) && !notificationBellBtn.contains(event.target)) {
                notificationModal.classList.remove('active');
            }
        });

        if (markAllReadBtn) {
            markAllReadBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch(window.API_MARK_NOTIFICATION_READ_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ mark_all: true }) // Send mark_all flag
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showToast(result.message, 'success');
                        fetchNotifications();
                    } else {
                        showToast(result.message || 'Failed to mark all as read.', 'error');
                    }
                } catch (error) {
                    console.error('Error marking all notifications as read:', error);
                    showToast('Network error marking notifications as read.', 'error');
                }
            });
        }

        async function fetchNotifications() {
            if (!window.currentUserId || window.currentUserId === 'null') {
                console.warn("Not authenticated. Cannot fetch notifications.");
                return;
            }
            try {
                const response = await fetch(`${window.API_GET_NOTIFICATIONS_URL}?unread_only=false`);  
                const data = await response.json();

                if (data.status === 'success') {
                    notificationList.innerHTML = '';
                    if (data.notifications.length === 0) {
                        noNotificationsMessage.classList.remove('hidden');
                        markAllReadBtn.classList.add('hidden');
                    } else {
                        noNotificationsMessage.classList.add('hidden'); // Hide "No new notifications"
                        markAllReadBtn.classList.remove('hidden');
                        data.notifications.forEach(notif => {
                            const notifElement = document.createElement('div');
                            notifElement.className = `notification-item ${notif.is_read ? '' : 'unread'}`;
                            notifElement.dataset.notificationId = notif.id;
                            notifElement.innerHTML = `
                                <p class="notification-message">${notif.message}</p>
                                <p class="notification-timestamp">${new Date(notif.created_at).toLocaleString()}</p>
                            `;
                            notifElement.addEventListener('click', async () => {
                                if (!notif.is_read) {
                                    await markNotificationAsRead(notif.id);
                                }
                                if (notif.link) {
                                    // Handle internal hash links for dashboard sections
                                    if (notif.link.startsWith('/profile/#')) {
                                        const targetHash = notif.link.split('#')[1];
                                        switchContentSection(targetHash);
                                        // If the link is specifically to a chat, open the chat modal
                                        // Ensure sender_uid and sender_username are available in notification data
                                        if (notif.sender_uid && notif.sender_username) {
                                            openChat(notif.sender_uid, notif.sender_username);
                                        }
                                    } else {
                                        window.location.href = notif.link;
                                    }
                                }
                                notificationModal.classList.remove('active');
                            });
                            notificationList.appendChild(notifElement);
                        });
                    }
                    
                    if (notificationBadge) {
                        if (data.unread_count > 0) {
                            notificationBadge.textContent = data.unread_count;
                            notificationBadge.classList.remove('hidden');
                        } else {
                            notificationBadge.classList.add('hidden');
                        }
                    }

                } else {
                    showToast(data.message || 'Failed to load notifications.', 'error');
                }
            } catch (error) {
                console.error('Error fetching notifications:', error);
                if (error instanceof TypeError) {
                    showToast('Network error fetching notifications.', 'error');
                }
            }
        }

        async function markNotificationAsRead(notificationId) {
            try {
                const response = await fetch(window.API_MARK_NOTIFICATION_READ_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ notification_id: notificationId })
                });
                const result = await response.json();
                if (result.status === 'success' || result.status === 'info') {
                    const markedNotifElement = notificationList.querySelector(`[data-notification-id="${notificationId}"]`);
                    if (markedNotifElement) {
                        markedNotifElement.classList.remove('unread');
                        markedNotifElement.classList.remove('bg-fef2f2');
                        markedNotifElement.classList.remove('font-semibold');
                    }
                    fetchNotifications();  // Re-fetch to update counts and list state
                } else {
                    showToast(result.message || 'Failed to mark notification as read.', 'error');
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
                showToast('Network error marking notification as read.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (window.currentUserId && window.currentUserId !== 'null') {
                fetchNotifications();
                if (notificationPollingInterval) {
                    clearInterval(notificationPollingInterval);
                }
                notificationPollingInterval = setInterval(fetchNotifications, 10000); // Poll every 10 seconds
            }
        });

    </script>
    <script src="{% static 'fairrent_app/js/main.js' %}" defer></script>
</body>
</html>
