{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Roomto.Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for consistent theming */
        :root {
            --primary: #6366f1; /* Indigo 500 */
            --primary-dark: #4f46e5; /* Indigo 600 */
            --secondary: #10b981; /* Teal 500 */
            --accent: #ec4899; /* Pink 500 */
            --dark: #1e293b; /* Slate 800 */
            --light: #f8fafc; /* Gray 50 */
        }
        
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* Lighter background */
            color: #111827; /* Darker text */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden; /* Prevent horizontal scroll on animations */
        }

        /* Modern glass card effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .glass-card:hover {
            transform: translateY(-5px); /* Slightly less lift on hover */
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.15);
        }

        /* Gradient text */
        .gradient-text {
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Floating animation (not directly used in this HTML, but kept for consistency) */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .floating {
            animation: float 6s ease-in-out infinite;
        }

        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Button hover effect */
        .btn-hover-effect {
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .btn-hover-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--primary), #9333ea, var(--accent));
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .btn-hover-effect:hover::before {
            opacity: 1;
        }

        /* Fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.8s ease-out forwards;
            opacity: 0; /* Ensure initial state is hidden */
        }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        .delay-300 { animation-delay: 0.3s; }
        .delay-400 { animation-delay: 0.4s; }
        .delay-500 { animation-delay: 0.5s; }

        /* General button styles */
        .btn-primary {
            background-color: var(--primary);
            color: white;
            padding: 0.9rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 12px -2px rgba(99, 102, 241, 0.4);
        }
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px -3px rgba(99, 102, 241, 0.5);
        }
        .btn-secondary {
            background-color: #e0e7ff; /* Light indigo */
            color: var(--primary);
            padding: 0.9rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
            border: 1px solid #c7d2fe;
        }
        .btn-secondary:hover {
            background-color: #c7d2fe;
            color: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Modal specific sizing for responsive full-screen feel */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(12px); /* Apply blur effect */
            -webkit-backdrop-filter: blur(12px); /* For Safari support */
            transition: backdrop-filter 0.3s ease-out; /* Smooth transition for blur */
        }
        .spinner {
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.5em 1.5em;
            padding-right: 3rem;
        }

        /* Dashboard Layout */
        .dashboard-container {
            display: flex;
            flex: 1;
        }
        .sidebar {
            width: 280px; /* Wider sidebar */
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); /* Darker gradient */
            color: white;
            padding: 2rem 1.5rem;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.3s ease-in-out;
            transform: translateX(0);
            z-index: 50;
            position: fixed; /* Always fixed for desktop */
            height: 100vh; /* Full height on desktop */
        }
        /* Mobile sidebar specific styles */
        @media (max-width: 1023px) {
            .dashboard-container {
                flex-direction: column; /* Stack on mobile */
            }
            .sidebar {
                position: fixed; /* Fixed position for mobile sidebar */
                height: 100vh;
                width: 280px; /* Fixed width for mobile sidebar */
                top: 0;
                left: 0;
                transform: translateX(-100%); /* Hidden by default on mobile */
                box-shadow: 5px 0 15px rgba(0,0,0,0.3); /* Stronger shadow when open */
            }
            .sidebar.open {
                transform: translateX(0); /* Slide in when open */
            }
            .content-area {
                margin-left: 0 !important; /* No margin when sidebar is hidden on mobile */
                width: 100%; /* Take full width on mobile */
            }
            /* Overlay for mobile sidebar */
            #sidebar-overlay {
                position: fixed;
                inset: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 40; /* Below sidebar, above content */
                display: none; /* Hidden by default */
            }
            #sidebar-overlay.active {
                display: block; /* Show when sidebar is open */
            }
        }

        .content-area {
            flex: 1;
            padding: 2rem;
            margin-left: 0;
            transition: margin-left 0.3s ease-in-out;
        }
        @media (min-width: 1024px) {
            .content-area {
                margin-left: 280px; /* Space for fixed sidebar */
            }
        }

        /* Card styles for dashboard (now using glass-card) */
        .dashboard-card {
            /* Inherits most styles from .glass-card */
            padding: 2rem; /* Consistent padding */
        }

        /* Stats cards */
        .stat-card {
            position: relative;
            overflow: hidden;
            /* Inherits glass-card for base styling */
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
            transition: all 0.5s ease;
        }
        .stat-card:hover::before {
            transform: rotate(45deg) translateY(-20px);
        }
        .stat-card .icon-wrapper-small {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Activity feed items */
        .activity-item {
            position: relative;
            padding-left: 2.5rem; /* Space for timeline dot/line */
            border-left: 2px solid #e2e8f0; /* Timeline line */
            padding-bottom: 1.5rem; /* Space between items */
            margin-bottom: 1.5rem; /* Space between items */
            cursor: pointer;
        }
        .activity-item:last-child {
            border-left: none; /* No line for the last item */
            padding-bottom: 0;
            margin-bottom: 0;
        }
        .activity-item::before {
            content: '';
            position: absolute;
            left: -0.5rem; /* Position the dot over the line */
            top: 0.5rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: var(--primary); /* Primary color dot */
            border: 3px solid white; /* White border to stand out */
            z-index: 1;
        }
        .activity-item .content {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        .activity-item:hover .content {
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .activity-item .activity-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-right: 0.75rem;
        }
        
        /* Roommate card */
        .roommate-match-container {
            position: relative;
            min-height: 500px; /* Ensure enough space for cards */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .roommate-match-card {
            /* Inherits glass-card for base styling */
            position: absolute; /* Stack cards */
            width: 90%; /* Max width for responsiveness */
            max-width: 450px; /* Max width for desktop */
            height: auto; /* Adjust height based on content */
            padding: 2rem;
            text-align: center;
            transition: transform 0.5s cubic-bezier(0.25, 0.8, 0.25, 1.2), opacity 0.5s ease-out, box-shadow 0.4s ease;
            transform-origin: center bottom;
            will-change: transform, opacity;
        }
        .roommate-match-card.swiping-right {
            transform: translateX(200%) rotate(45deg);
            opacity: 0;
        }
        .roommate-match-card.swiping-left {
            transform: translateX(-200%) rotate(-45deg);
            opacity: 0;
        }
        .roommate-match-card img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1.5rem;
            border: 4px solid var(--primary);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .compatibility-score {
            font-size: 2.5rem; /* Slightly smaller for card */
            font-weight: 900;
            background: linear-gradient(45deg, var(--primary), #8b5cf6, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.05em;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .match-detail-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 1rem;
            color: #4a5568;
        }
        .match-detail-item i {
            margin-right: 1rem;
            color: #9ca3af;
            width: 1.4rem;
            text-align: center;
        }

        /* Swipe buttons */
        .swipe-buttons {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 2rem;
            position: relative;
            z-index: 30;
        }
        .swipe-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1.2), box-shadow 0.3s ease, background-color 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            border: 2px solid transparent;
        }
        .swipe-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
        }
        .swipe-button.skip {
            background-color: #ef4444;
            color: white;
            border-color: #dc2626;
        }
        .swipe-button.like {
            background-color: #22c55e;
            color: white;
            border-color: #16a34a;
        }

        /* Lifestyle Preferences Tags */
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.75rem;
            background-color: #f8fafc;
            min-height: 48px;
            align-items: center;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        .tag {
            background-color: #e0e7ff;
            color: var(--primary);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #c7d2fe;
            user-select: none;
        }
        .tag:hover {
            background-color: #c7d2fe;
            transform: translateY(-1px);
        }
        .tag.selected {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 5px rgba(99,102,241,0.2);
        }
        .tag.selected:hover {
            background-color: var(--primary-dark);
            transform: translateY(0);
        }

        /* Tab buttons for main content areas */
        .main-content-tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 2rem;
        }
        .main-content-tab-button {
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: #64748b; /* Slate 500 */
            transition: all 0.2s ease;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px; /* Pulls button border up to align with parent border */
        }
        .main-content-tab-button:hover {
            color: var(--primary-dark);
        }
        .main-content-tab-button.active {
            color: var(--primary);
            border-color: var(--primary);
        }

        /* Activity/Service Details Modal */
        .activity-detail-modal-content .detail-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            font-size: 1rem;
            color: #4a5568;
        }
        .activity-detail-modal-content .detail-item i {
            margin-right: 0.75rem;
            color: #94a3b8;
            width: 1.2rem;
            text-align: center;
            flex-shrink: 0;
            padding-top: 0.1rem;
        }
        .activity-detail-modal-content .detail-item span {
            font-weight: 500;
            color: #2d3748;
        }
        .activity-detail-modal-content .detail-item p {
            margin-top: 0.1rem;
            font-size: 0.9rem;
            color: #4a5568;
        }

        /* Specific styles for Rent Checker results in dashboard */
        .rent-checker-result-card {
            background: linear-gradient(135deg, #e0f2fe, #bfdbfe); /* Light blue gradient */
            border: 1px solid #93c5fd;
            border-radius: 1.25rem;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }
        .rent-checker-result-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        .rent-checker-result-card .icon-wrapper {
            width: 3rem;
            height: 3rem;
            min-width: 3rem;
            min-height: 3rem;
            border-radius: 0.75rem;
            background-color: #3b82f6; /* Blue-600 */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .rent-checker-result-card .details {
            flex-grow: 1;
        }
        .rent-checker-result-card .details p {
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
            color: #374151; /* Darker gray for text */
        }
        .rent-checker-result-card .details .highlight {
            font-weight: 600;
            color: #1d4ed8; /* Blue-700 */
        }
        .rent-checker-result-card .details .timestamp {
            font-size: 0.8rem;
            color: #6b7280; /* Gray-500 */
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div id="dashboard-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="hidden lg:flex">
            <div>
                <div class="text-white text-2xl font-extrabold mb-10 tracking-wide flex items-center space-x-2">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l-7 7m7-7v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    <span>Roomto.Live</span>
                </div>
                <nav>
                    <ul class="space-y-4">
                        <li>
                            <a href="#" class="sidebar-nav-item active flex items-center p-3 rounded-lg text-lg font-medium hover:bg-slate-700 transition-colors duration-200" data-content-target="dashboard-home">
                                <i class="fas fa-home mr-3"></i> Dashboard
                            </a>
                        </li>
                        <li>
                            <a href="#" class="sidebar-nav-item flex items-center p-3 rounded-lg text-lg font-medium hover:bg-slate-700 transition-colors duration-200" data-content-target="roommate-finder-section">
                                <i class="fas fa-users mr-3"></i> Roommate Finder
                            </a>
                        </li>
                        <li>
                            <a href="#" class="sidebar-nav-item flex items-center p-3 rounded-lg text-lg font-medium hover:bg-slate-700 transition-colors duration-200" data-content-target="my-services-section">
                                <i class="fas fa-tools mr-3"></i> My Services
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="border-t border-slate-700 pt-6">
                <!-- "Go to Homepage" is now a regular link, no data-content-target -->
                <a href="{% url 'fairrent_app:index' %}" class="flex items-center p-3 rounded-lg text-lg font-medium text-indigo-300 hover:text-white hover:bg-indigo-700 transition-colors duration-200">
                    <i class="fas fa-arrow-circle-left mr-4"></i> Homepage
                </a>
                <a href="{% url 'fairrent_app:logout' %}" class="flex items-center p-3 rounded-lg text-lg font-medium text-red-400 hover:bg-slate-700 transition-colors duration-200 mt-2">
                    <i class="fas fa-sign-out-alt mr-4"></i> Logout
                </a>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="content-area" class="flex-1">
            <!-- Mobile Header for Sidebar Toggle -->
            <div class="lg:hidden flex justify-between items-center mb-6">
                <button id="sidebar-toggle-btn" class="text-gray-600 hover:text-indigo-600 focus:outline-none text-2xl">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="text-3xl font-extrabold text-gray-900">Dashboard</h1>
                <div class="w-8"></div> <!-- Spacer -->
            </div>

            <!-- Content Sections (Dynamically Swapped) -->
            <section id="dashboard-home" class="content-section active space-y-8">
                <div class="mb-8">
                    <h2 class="text-4xl font-extrabold text-gray-900 leading-tight">Welcome, <span class="gradient-text">{{ user.username }}</span>!</h2>
                    <p class="text-xl text-gray-600 mt-2 text-xl">Here's a quick overview of your Roomto.Live activity.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- User Info Card (Compact) -->
                    <div class="glass-card p-6 col-span-1 md:col-span-1 lg:col-span-1 animate-fade-in delay-100">
                        <h3 class="text-2xl font-bold text-gray-900 mb-5">Your Profile Overview</h3>
                        <div class="flex items-center mb-5">
                            <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 mr-4 shadow-inner">
                                <i class="fas fa-user fa-2x"></i>
                            </div>
                            <div>
                                <p class="text-xl font-bold text-gray-900">{{ user.username }}</p>
                                <p class="text-sm text-gray-500">{{ user.email }}</p>
                            </div>
                        </div>
                        <div class="text-base text-gray-600 space-y-2 border-t pt-5 mt-5 border-gray-100">
                            <p class="flex items-center"><i class="fas fa-calendar-plus w-5 mr-3 text-gray-400"></i>Joined {{ user.date_joined|date:"F Y" }}</p>
                            {% if user_roommate_profile %}
                                <p class="flex items-center"><i class="fas fa-venus-mars w-5 mr-3 text-gray-400"></i>Gender: {{ user_roommate_profile.get_gender_display|default:'N/A' }}</p>
                                <p class="flex items-center"><i class="fas fa-money-bill-wave w-5 mr-3 text-gray-400"></i>Budget: £{{ user_roommate_profile.budget|default:'N/A' }}</p>
                                <p class="flex items-center"><i class="fas fa-map-marker-alt w-5 mr-3 text-gray-400"></i>Location: {{ user_roommate_profile.location|default:'N/A' }}</p>
                            {% endif %}
                        </div>
                        <button id="edit-profile-btn-dashboard-home" class="btn-secondary w-full mt-6 flex items-center justify-center btn-hover-effect">
                            <i class="fas fa-edit mr-2"></i>{% if user_roommate_profile %}Edit Profile{% else %}Create Profile{% endif %}
                        </button>
                    </div>

                    <!-- Quick Stats Card -->
                    <div class="glass-card p-6 col-span-1 md:col-span-1 lg:col-span-2 animate-fade-in delay-200">
                        <h3 class="text-2xl font-bold text-gray-900 mb-5">Quick Stats</h3>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="p-4 bg-blue-50 rounded-lg shadow-sm">
                                <p class="text-3xl font-bold text-blue-600">{{ user_rent_checks|length }}</p>
                                <p class="text-gray-600 text-sm">Rent Checks</p>
                            </div>
                            <div class="p-4 bg-green-50 rounded-lg shadow-sm">
                                <p class="text-3xl font-bold text-green-600">{{ user_reviews|length }}</p>
                                <p class="text-gray-600 text-sm">Reviews Submitted</p>
                            </div>
                            <div class="p-4 bg-red-50 rounded-lg shadow-sm">
                                <p class="text-3xl font-bold text-red-600">{{ user_complaints|length }}</p>
                                <p class="text-gray-600 text-sm">Complaints Filed</p>
                            </div>
                            <div class="p-4 bg-purple-50 rounded-lg shadow-sm">
                                <p class="text-3xl font-bold text-purple-600">{{ user_liked_profiles|length }}</p>
                                <p class="text-gray-600 text-sm">Profiles Liked</p>
                            </div>
                            <!-- NEW: Contract Analyses Stat -->
                            <div class="p-4 bg-teal-50 rounded-lg shadow-sm">
                                <p class="text-3xl font-bold text-teal-600">{{ user_rental_contracts|length }}</p>
                                <p class="text-gray-600 text-sm">Contracts Analyzed</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Card (Full Width) -->
                <div class="glass-card p-6 animate-fade-in delay-300">
                    <h3 class="text-2xl font-bold text-gray-900 mb-6">Recent Activity</h3>
                    <div id="recent-activity-list" class="space-y-3">
                        {% if recent_activities %}
                            {% for activity in recent_activities %}
                                <div class="activity-item cursor-pointer"
                                    data-activity-type="{{ activity.type }}"
                                    data-activity-details='{% if activity.details %}{{ activity.details|json_script:"activity_details_data" }}{% endif %}'>
                                    <div class="content flex items-start">
                                        <div class="activity-icon bg-{{ activity.color }}-100 text-{{ activity.color }}-600">
                                            <i class="fas fa-{{ activity.icon }}"></i>
                                        </div>
                                        <div>
                                            <p class="text-gray-800 font-medium">{{ activity.description }}</p>
                                            <p class="text-sm text-gray-500">{{ activity.timestamp|date:"M d, Y H:i" }}</p>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-center text-gray-500 py-4">No recent activity to display.</p>
                        {% endif %}
                    </div>
                </div>
            </section>

            <!-- Roommate Finder Section (Full Page View) -->
            <section id="roommate-finder-section" class="content-section hidden space-y-8 animate-fade-in">
                <div class="glass-card p-8">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h3 class="text-3xl font-bold text-gray-900">AI Roommate Finder</h3>
                            <p class="text-gray-500 mt-1">Discover compatible roommates with our smart AI.</p>
                        </div>
                        <button id="edit-profile-btn-roommate-section" class="btn-primary flex items-center btn-hover-effect">
                            <i class="fas fa-edit mr-2"></i>{% if user_roommate_profile %}Edit Profile{% else %}Create Profile{% endif %}
                        </button>
                    </div>
                    <div id="roommate-match-container" class="relative min-h-[400px] bg-gray-50 rounded-xl border border-gray-200 overflow-hidden flex items-center justify-center">
                        <div id="roommate-matches-loader" class="absolute inset-0 flex flex-col items-center justify-center bg-white bg-opacity-90 rounded-xl hidden z-20">
                            <div class="spinner w-16 h-16 border-6 border-gray-200 rounded-full mb-4"></div>
                            <p class="text-gray-700 font-medium text-lg">Finding your perfect matches with AI...</p>
                        </div>
                        
                        <div id="roommate-match-card-display" class="absolute inset-0 flex items-center justify-center z-10">
                            <!-- Dynamic match cards will be loaded here -->
                        </div>

                        <div id="roommate-prompt" class="text-center p-6 w-full h-full flex flex-col items-center justify-center z-10">
                            <i class="fas fa-users text-6xl text-gray-400 mb-6"></i>
                            <p class="mt-4 font-semibold text-gray-700 text-xl">Your potential matches will appear here.</p>
                            <p class="text-gray-500 mt-2 text-lg">{% if user.is_authenticated and user_roommate_profile %}Click "Find Matches" to begin your search!{% else %}Create your profile to get started and find your ideal roommate.{% endif %}</p>
                            {% if user.is_authenticated and user_roommate_profile %}<button id="find-matches-btn-inner" class="mt-8 btn-primary text-lg btn-hover-effect"><i class="fas fa-search mr-3"></i>Find Matches</button>{% endif %}
                        </div>

                        <div id="no-more-matches-prompt" class="hidden text-center p-6 w-full h-full flex flex-col items-center justify-content-center z-10">
                            <i class="fas fa-heart-broken text-6xl text-gray-400 mb-6"></i>
                            <p class="mt-4 font-semibold text-gray-700 text-xl">No more matches for now!</p>
                            <p class="text-gray-500 mt-2 text-lg">Check back later or refine your profile to discover new connections.</p>
                            <button id="reset-matches-btn" class="mt-8 btn-secondary text-lg btn-hover-effect"><i class="fas fa-redo mr-3"></i>Restart Matches</button>
                        </div>
                    </div>
                    
                    <div id="swipe-buttons-container" class="swipe-buttons hidden z-30">
                        <button id="skip-match-btn" class="swipe-button skip"><i class="fas fa-times"></i></button>
                        <button id="like-match-btn" class="swipe-button like"><i class="fas fa-check"></i></button>
                    </div>
                </div>
            </section>

            <!-- My Services & Activity Tabs -->
            <section id="my-services-section" class="content-section hidden space-y-8 animate-fade-in">
                <div class="glass-card p-6">
                    <h3 class="text-2xl font-bold text-gray-900 mb-6">My Services & Activity</h3>
                    
                    <div class="main-content-tabs flex border-b-2 border-gray-200 mb-6">
                        <button class="main-content-tab-button active" data-tab-id="my-recent-activity-tab">Recent Activity</button>
                        <button class="main-content-tab-button" data-tab-id="my-service-results-tab">My Service Results</button>
                    </div>

                    <div id="my-recent-activity-tab" class="main-content-tab-content space-y-3">
                        {% if recent_activities %}
                            {% for activity in recent_activities %}
                                <div class="activity-item cursor-pointer"
                                    data-activity-type="{{ activity.type }}"
                                    data-activity-details='{% if activity.details %}{{ activity.details|json_script:"activity_details_data" }}{% endif %}'>
                                    <div class="content flex items-start">
                                        <div class="activity-icon bg-{{ activity.color }}-100 text-{{ activity.color }}-600">
                                            <i class="fas fa-{{ activity.icon }}"></i>
                                        </div>
                                        <div>
                                            <p class="text-gray-800 font-medium">{{ activity.description }}</p>
                                            <p class="text-sm text-gray-500">{{ activity.timestamp|date:"M d, Y H:i" }}</p>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-center text-gray-500 py-4">No recent activity to display.</p>
                        {% endif %}
                    </div>

                    <div id="my-service-results-tab" class="main-content-tab-content hidden space-y-3">
                        {% if user_rent_checks or user_reviews or user_complaints or user_forum_posts or user_liked_profiles or user_rental_contracts or user_rent_declaration_checks %}
                            {% for rent_result in user_rent_checks %}
                                <div class="service-result-card cursor-pointer rent-checker-result-card"
                                    data-activity-type="Rent Check"
                                    data-activity-details='{
                                        "postcode": "{{ rent_result.postcode }}",
                                        "bedrooms": "{{ rent_result.bedrooms }}",
                                        "estimated_rent": "{{ rent_result.estimated_rent|floatformat:0 }}",
                                        "checked_at": "{{ rent_result.checked_at|date:"Y-m-d H:i:s" }}"
                                    }'>
                                    <div class="icon-wrapper bg-blue-100 text-blue-600">
                                        <i class="fas fa-gbp-sign"></i>
                                    </div>
                                    <div class="details">
                                        <p>Rent Check for <span class="highlight">{{ rent_result.postcode }}</span> ({{ rent_result.bedrooms }} bed)</p>
                                        <p>Estimated Rent: <span class="highlight">£{{ rent_result.estimated_rent|floatformat:0 }}</span></p>
                                        <p class="timestamp">Checked on {{ rent_result.checked_at|date:"M d, Y" }}</p>
                                    </div>
                                </div>
                            {% endfor %}

                            {% for review in user_reviews %}
                                <div class="service-result-card cursor-pointer glass-card p-4 flex items-center"
                                    data-activity-type="Review"
                                    data-activity-details='{
                                        "landlord_name": "{{ review.landlord_name }}",
                                        "property_address": "{{ review.property_address }}",
                                        "rating": {{ review.rating }},
                                        "comments": "{{ review.comments|escapejs }}",
                                        "reviewed_at": "{{ review.reviewed_at|date:"Y-m-d H:i:s" }}",
                                        "reviewer": "{{ review.user.username }}"
                                    }'>
                                    <div class="icon-wrapper-small bg-green-100 text-green-600 mr-4">
                                        <i class="fas fa-star"></i>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800">Your Review for <span class="font-bold">{{ review.landlord_name }}</span> ({{ review.property_address }})</p>
                                        <p class="text-gray-700">Rating: <span class="font-bold text-green-600">{{ review.rating }} Stars</span></p>
                                        <p class="text-sm text-gray-500">"{{ review.comments|truncatechars:100 }}"</p>
                                        <p class="text-sm text-gray-500">Submitted on {{ review.reviewed_at|date:"M d, Y" }}</p>
                                    </div>
                                </div>
                            {% endfor %}

                            {% for complaint in user_complaints %}
                                <div class="service-result-card cursor-pointer glass-card p-4 flex items-center"
                                    data-activity-type="Complaint"
                                    data-activity-details='{
                                        "issue_type": "{{ complaint.get_issue_type_display }}",
                                        "property_address": "{{ complaint.property_address }}",
                                        "landlord_name": "{{ complaint.landlord_name|default:'' }}",
                                        "description": "{{ complaint.description|escapejs }}",
                                        "status": "{{ complaint.get_status_display }}",
                                        "submitted_at": "{{ complaint.submitted_at|date:"Y-m-d H:i:s" }}"
                                    }'>
                                    <div class="icon-wrapper-small bg-red-100 text-red-600 mr-4">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800">Complaint: <span class="font-bold">{{ complaint.get_issue_type_display }}</span> (<span class="font-bold">{{ complaint.property_address }}</span>)</p>
                                        <p class="text-gray-700">Status: <span class="text-orange-500 font-semibold">{{ complaint.get_status_display }}</span></p>
                                        <p class="text-sm text-gray-500">Submitted on {{ complaint.submitted_at|date:"M d, Y" }}</p>
                                    </div>
                                </div>
                            {% endfor %}

                            {% for post in user_forum_posts %}
                                <div class="service-result-card cursor-pointer glass-card p-4 flex items-center"
                                    data-activity-type="Forum Post"
                                    data-activity-details='{
                                        "title": "{{ post.title|escapejs }}",
                                        "content": "{{ post.content|escapejs }}",
                                        "category": "{{ post.get_category_display }}",
                                        "created_at": "{{ post.created_at|date:"Y-m-d H:i:s" }}",
                                        "author": "{{ post.user.username }}"
                                    }'>
                                    <div class="icon-wrapper-small bg-yellow-100 text-yellow-600 mr-4">
                                        <i class="fas fa-comments"></i>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800">Forum Post: <span class="font-bold">"{{ post.title }}"</span></p>
                                        <p class="text-gray-700">Category: <span class="font-bold">{{ post.get_category_display }}</span></p>
                                        <p class="text-sm text-gray-500">Posted on {{ post.created_at|date:"M d, Y" }}</p>
                                    </div>
                                </div>
                            {% endfor %}

                            {% for liked_profile in user_liked_profiles %}
                                <div class="service-result-card cursor-pointer glass-card p-4 flex items-center"
                                    data-activity-type="Liked Profile"
                                    data-activity-details='{
                                        "name": "{{ liked_profile.liked_user_name }}",
                                        "age": {{ liked_profile.liked_user_age|default:"null" }},
                                        "gender": "{{ liked_profile.liked_user_gender }}",
                                        "location": "{{ liked_profile.liked_user_location }}",
                                        "budget": {{ liked_profile.liked_user_budget|default:"null" }},
                                        "bio": "{{ liked_profile.liked_user_bio|escapejs }}",
                                        "compatibility_score": {{ liked_profile.liked_user_compatibility_score|default:"null" }},
                                        "avatar_url": "{{ liked_profile.liked_user_avatar_url }}"
                                    }'>
                                    <div class="icon-wrapper-small bg-pink-100 text-pink-500 mr-4">
                                        <i class="fas fa-heart"></i>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800">Liked Profile: <span class="font-bold">{{ liked_profile.liked_user_name }}</span></p>
                                        <p class="text-gray-700">Compatibility: <span class="font-bold text-blue-600">{{ liked_profile.liked_user_compatibility_score|default:'N/A' }}%</span></p>
                                        <p class="text-sm text-gray-500">Liked on {{ liked_profile.liked_at|date:"M d, Y" }}</p>
                                    </div>
                                </div>
                            {% endfor %}

                            {% for contract in user_rental_contracts %}
                                <div class="service-result-card cursor-pointer glass-card p-4 flex items-center"
                                    data-activity-type="Contract Analysis"
                                    data-activity-details='{
                                        "original_text": "{{ contract.original_text|escapejs }}",
                                        "analysis_result": "{{ contract.analysis_result|escapejs }}",
                                        "analyzed_at": "{{ contract.analyzed_at|date:"Y-m-d H:i:s" }}"
                                    }'>
                                    <div class="icon-wrapper-small bg-teal-100 text-teal-600 mr-4">
                                        <i class="fas fa-file-contract"></i>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800">Contract Analysis</p>
                                        <p class="text-gray-700">Analyzed on <span class="font-bold">{{ contract.analyzed_at|date:"M d, Y" }}</span></p>
                                        <p class="text-sm text-gray-500">Preview: "{{ contract.original_text|truncatechars:100 }}"</p>
                                    </div>
                                </div>
                            {% endfor %}

                            {% for declaration_check in user_rent_declaration_checks %}
                                <div class="service-result-card cursor-pointer glass-card p-4 flex items-center"
                                    data-activity-type="Rent Declaration Check"
                                    data-activity-details='{
                                        "postcode": "{{ declaration_check.postcode }}",
                                        "bedrooms": "{{ declaration_check.bedrooms }}",
                                        "actual_rent_paid": "{{ declaration_check.actual_rent_paid }}",
                                        "council_tax_band": "{{ declaration_check.council_tax_band }}",
                                        "estimated_council_tax": "{{ declaration_check.estimated_council_tax|default:"null" }}",
                                        "discrepancy_found": {{ declaration_check.discrepancy_found|lower }},
                                        "analysis_result": "{{ declaration_check.analysis_result|escapejs }}",
                                        "checked_at": "{{ declaration_check.checked_at|date:"Y-m-d H:i:s" }}"
                                    }'>
                                    <div class="icon-wrapper-small bg-orange-100 text-orange-600 mr-4">
                                        <i class="fas fa-file-invoice-dollar"></i>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800">Rent Declaration Check for <span class="font-bold">{{ declaration_check.postcode }}</span></p>
                                        <p class="text-gray-700">Discrepancy: <span class="font-bold {% if declaration_check.discrepancy_found %}text-red-600{% else %}text-green-600{% endif %}">{{ declaration_check.discrepancy_found|yesno:"Found,None" }}</span></p>
                                        <p class="text-sm text-gray-500">Checked on {{ declaration_check.checked_at|date:"M d, Y" }}</p>
                                    </div>
                                </div>
                            {% endfor %}

                            {% else %}
                                <p class="text-center text-gray-500 py-2">No service results to display yet.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Roommate Profile Edit Modal -->
    <div id="profile-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="profile-modal-title">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto relative transform transition-all sm:my-8 sm:align-middle sm:max-w-xl sm:w-full p-8">
            <button type="button" id="close-profile-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none p-2 rounded-full hover:bg-gray-100 transition-colors">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <form id="roommate-profile-form" class="space-y-6">
                <h3 id="profile-modal-title" class="text-3xl font-bold mb-6 text-gray-900">Your Roommate Profile</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="age" class="block text-sm font-medium text-gray-700 mb-1">Age</label>
                        <input type="number" id="age" name="age" value="{{ user_roommate_profile.age|default:'' }}"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3"
                               min="18" max="99" placeholder="e.g., 25">
                    </div>
                    <div>
                        <label for="gender" class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                        <select id="gender" name="gender"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3">
                            <option value="">Select Gender</option>
                            <option value="male" {% if user_roommate_profile.gender == 'male' %}selected{% endif %}>Male</option>
                            <option value="female" {% if user_roommate_profile.gender == 'female' %}selected{% endif %}>Female</option>
                            <option value="other" {% if user_roommate_profile.gender == 'other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="sleep_schedule" class="block text-sm font-medium text-gray-700 mb-1">Sleep Schedule</label>
                        <select id="sleep_schedule" name="sleep_schedule"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3">
                            <option value="">Select Schedule</option>
                            <option value="early_bird" {% if user_roommate_profile.sleep_schedule == 'early_bird' %}selected{% endif %}>Early Bird</option>
                            <option value="night_owl" {% if user_roommate_profile.sleep_schedule == 'night_owl' %}selected{% endif %}>Night Owl</option>
                            <option value="flexible" {% if user_roommate_profile.sleep_schedule == 'flexible' %}selected{% endif %}>Flexible</option>
                        </select>
                    </div>
                    <div>
                        <label for="cleanliness" class="block text-sm font-medium text-gray-700 mb-1">Cleanliness</label>
                        <select id="cleanliness" name="cleanliness"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3">
                            <option value="">Select Cleanliness</option>
                            <option value="very_tidy" {% if user_roommate_profile.cleanliness == 'very_tidy' %}selected{% endif %}>Very Tidy</option>
                            <option value="average" {% if user_roommate_profile.cleanliness == 'average' %}selected{% endif %}>Average</option>
                            <option value="relaxed" {% if user_roommate_profile.cleanliness == 'relaxed' %}selected{% endif %}>Relaxed</option>
                        </select>
                    </div>
                    <div>
                        <label for="budget" class="block text-sm font-medium text-gray-700 mb-1">Max Budget (£/month)</label>
                        <input type="number" id="budget" name="budget" value="{{ user_roommate_profile.budget|default:'' }}"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3"
                               min="100" max="5000" placeholder="e.g., 800">
                    </div>
                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Desired Location</label>
                        <input type="text" id="location" name="location" value="{{ user_roommate_profile.location|default:'' }}"
                               placeholder="e.g., East London"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Lifestyle Preferences</label>
                    <div id="lifestyle-preferences-tags" class="tag-input-container">
                        <!-- Tags will be injected here by JavaScript -->
                    </div>
                    <input type="hidden" id="lifestyle_preferences_hidden" name="lifestyle_preferences" value="{{ user_roommate_profile.lifestyle_preferences|default:'' }}">
                </div>
                <div class="mt-4">
                    <label for="bio" class="block text-sm font-medium text-gray-700 mb-1">Bio</label>
                    <textarea id="bio" name="bio" rows="4"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3"
                               placeholder="Tell us about yourself and what you're looking for... (max 500 words)">{{ user_roommate_profile.bio|default:'' }}</textarea>
                </div>
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" id="profile-form-cancel-btn" class="btn-secondary btn-hover-effect">Cancel</button>
                    <button type="submit" class="btn-primary btn-hover-effect">Save Profile</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generic Activity/Service Details Modal -->
    <div id="activity-details-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="activity-modal-title">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-8 relative transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full">
            <button type="button" id="close-activity-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none p-2 rounded-full hover:bg-gray-100 transition-colors">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <div id="activity-modal-content" class="text-left activity-detail-modal-content">
                <!-- Activity/Service details will be injected here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Alert/Toast Notification -->
    <div id="alert-toast" class="fixed bottom-5 right-5 z-50 hidden p-4 rounded-lg text-white transition-transform transform translate-y-20">
        <p id="alert-message"></p>
    </div>

    <script>
        // Helper function to show toast notifications
        function showToast(message, type = 'success') {
            const toast = document.getElementById('alert-toast');
            const msgElement = document.getElementById('alert-message');
            msgElement.textContent = message;
            
            toast.className = 'fixed bottom-5 right-5 z-50 p-4 rounded-lg text-white transition-transform transform';
            if (type === 'success') {
                toast.classList.add('bg-green-500');
            } else if (type === 'error') {
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.add('bg-gray-700');
            }
            
            toast.classList.remove('translate-y-20'); // Show toast
            setTimeout(() => {
                toast.classList.add('translate-y-20'); // Hide toast
            }, 3000);
        }

        // --- Dashboard Navigation Logic ---
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const sidebar = document.getElementById('sidebar');
        const contentArea = document.getElementById('content-area');
        const sidebarNavItems = document.querySelectorAll('.sidebar-nav-item');
        const contentSections = document.querySelectorAll('.content-section');

        // Toggle sidebar for mobile
        if (sidebarToggleBtn) {
            sidebarToggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                // Create/remove overlay for mobile
                let overlay = document.getElementById('sidebar-overlay');
                if (sidebar.classList.contains('open')) {
                    if (!overlay) {
                        overlay = document.createElement('div');
                        overlay.id = 'sidebar-overlay';
                        overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden';
                        document.body.appendChild(overlay);
                        overlay.addEventListener('click', () => {
                            sidebar.classList.remove('open');
                            overlay.classList.remove('active');
                            overlay.remove(); // Remove the overlay from DOM when closing
                        });
                    }
                    overlay.classList.add('active'); // Activate the overlay
                } else {
                    if (overlay) {
                        overlay.classList.remove('active'); // Deactivate the overlay
                        overlay.remove(); // Remove the overlay from DOM when closing
                    }
                }
            });
        }

        // Switch content sections based on sidebar navigation
        sidebarNavItems.forEach(item => {
            item.addEventListener('click', (e) => {
                const targetId = item.dataset.contentTarget;
                // ONLY prevent default for internal navigation links (those with data-content-target)
                // This allows the "Back to Home" link (which doesn't have data-content-target) to function normally
                if (targetId) {
                    e.preventDefault();
                    // Remove active from all nav items
                    sidebarNavItems.forEach(nav => nav.classList.remove('active', 'bg-slate-700'));
                    // Add active to clicked nav item
                    item.classList.add('active', 'bg-slate-700');

                    // Hide all content sections
                    contentSections.forEach(section => section.classList.add('hidden'));
                    // Show target content section
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) {
                        targetSection.classList.remove('hidden');
                    }

                    // Close sidebar on mobile after selection
                    if (window.innerWidth < 1024) {
                        sidebar.classList.remove('open');
                        document.getElementById('sidebar-overlay')?.classList.remove('active'); // Deactivate overlay
                        document.getElementById('sidebar-overlay')?.remove(); // Remove overlay from DOM
                    }
                }
            });
        });

        // Initialize active sidebar item and content section on load
        document.addEventListener('DOMContentLoaded', () => {
            // Check current URL hash or default to dashboard-home
            const initialSectionId = window.location.hash ? window.location.hash.substring(1) : 'dashboard-home';
            const initialNavItem = document.querySelector(`.sidebar-nav-item[data-content-target="${initialSectionId}"]`);
            const initialContentSection = document.getElementById(initialSectionId);

            if (initialNavItem) {
                initialNavItem.classList.add('active', 'bg-slate-700');
            } else {
                // Fallback to default if hash is invalid
                document.querySelector('.sidebar-nav-item[data-content-target="dashboard-home"]').classList.add('active', 'bg-slate-700');
            }

            if (initialContentSection) {
                initialContentSection.classList.remove('hidden');
            } else {
                document.getElementById('dashboard-home').classList.remove('hidden');
            }

            // Adjust content area margin on desktop
            if (window.innerWidth >= 1024) {
                contentArea.style.marginLeft = '250px';
            }
        });

        // --- Roommate Profile Modal Logic ---
        const profileModal = document.getElementById('profile-modal');
        const editProfileBtnDashboardHome = document.getElementById('edit-profile-btn-dashboard-home');
        const editProfileBtnRoommateSection = document.getElementById('edit-profile-btn-roommate-section');
        const closeProfileModalBtn = document.getElementById('close-profile-modal-btn');
        const profileFormCancelBtn = document.getElementById('profile-form-cancel-btn');
        const roommateProfileForm = document.getElementById('roommate-profile-form');
        const lifestylePreferencesTagsContainer = document.getElementById('lifestyle-preferences-tags');
        const lifestylePreferencesHiddenInput = document.getElementById('lifestyle_preferences_hidden');
        const profileLocationInput = document.getElementById('location');

        // Pre-defined lifestyle preferences
        const ALL_LIFESTYLE_PREFERENCES = [
            'Quiet', 'Social', 'Pet-Friendly', 'Clean', 'Messy', 'Early Bird',
            'Night Owl', 'Studious', 'Party-goer', 'Vegetarian', 'Vegan',
            'Cooks Often', 'Rarely Cooks', 'Non-Smoker', 'Smoker', 'Introvert', 'Extrovert'
        ];

        // Function to render lifestyle preference tags
        function renderLifestylePreferenceTags(selectedPreferences = []) {
            if (!lifestylePreferencesTagsContainer) return;
            lifestylePreferencesTagsContainer.innerHTML = ''; // Clear existing tags
            ALL_LIFESTYLE_PREFERENCES.forEach(pref => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.textContent = pref;
                if (selectedPreferences.includes(pref)) {
                    tag.classList.add('selected');
                }
                tag.addEventListener('click', () => {
                    tag.classList.toggle('selected');
                    updateLifestylePreferencesHiddenInput();
                });
                lifestylePreferencesTagsContainer.appendChild(tag);
            });
        }

        // Function to update the hidden input based on selected tags
        function updateLifestylePreferencesHiddenInput() {
            if (!lifestylePreferencesTagsContainer || !lifestylePreferencesHiddenInput) return;
            const selectedTags = Array.from(lifestylePreferencesTagsContainer.querySelectorAll('.tag.selected')).map(tag => tag.textContent);
            lifestylePreferencesHiddenInput.value = selectedTags.join(', ');
        }

        // Event listeners for opening profile modal from different buttons
        const openProfileModal = () => {
            const currentPrefsString = lifestylePreferencesHiddenInput ? lifestylePreferencesHiddenInput.value : '';
            const currentPrefsArray = currentPrefsString.split(',').map(item => item.trim()).filter(item => item.length > 0);
            renderLifestylePreferenceTags(currentPrefsArray);
            if (profileModal) {
                profileModal.classList.remove('hidden');
                profileModal.classList.add('flex');
            }
        };
        if (editProfileBtnDashboardHome) {
            editProfileBtnDashboardHome.addEventListener('click', openProfileModal);
        }
        if (editProfileBtnRoommateSection) {
            editProfileBtnRoommateSection.addEventListener('click', openProfileModal);
        }

        if (closeProfileModalBtn) {
            closeProfileModalBtn.addEventListener('click', () => {
                if (profileModal) {
                    profileModal.classList.add('hidden');
                    profileModal.classList.remove('flex');
                }
            });
        }

        if (profileFormCancelBtn) {
            profileFormCancelBtn.addEventListener('click', () => {
                if (profileModal) {
                    profileModal.classList.add('hidden');
                    profileModal.classList.remove('flex');
                }
            });
        }

        if (roommateProfileForm) {
            roommateProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = roommateProfileForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

                const formData = new FormData(roommateProfileForm);
                const data = Object.fromEntries(formData.entries());
                data.age = data.age ? parseInt(data.age) : null;
                data.budget = data.budget ? parseInt(data.budget) : null;

                try {
                    const response = await fetch('/api/save_roommate_profile/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        showToast(result.message, 'success');
                        if (profileModal) {
                            profileModal.classList.add('hidden');
                            profileModal.classList.remove('flex');
                        }
                        location.reload();
                    } else {
                        showToast(result.message || 'Failed to save profile.', 'error');
                        if (profileModal) {
                            profileModal.classList.remove('hidden');
                            profileModal.classList.add('flex');
                        }
                    }
                } catch (error) {
                    console.error('Network error:', error);
                    showToast('Network error. Please try again.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Profile';
                }
            });
        }
        // Assuming setupAddressSuggestions is defined in main.js or globally
        // setupAddressSuggestions(profileLocationInput); // This needs to be called after the element is guaranteed to exist


        // --- Roommate Match Finder Logic (Swipe UI) ---
        const findMatchesBtn = document.getElementById('find-matches-btn');
        const roommateMatchesLoader = document.getElementById('roommate-matches-loader');
        const roommateMatchCardDisplay = document.getElementById('roommate-match-card-display');
        const roommatePrompt = document.getElementById('roommate-prompt');
        const noMoreMatchesPrompt = document.getElementById('no-more-matches-prompt');
        const resetMatchesBtn = document.getElementById('reset-matches-btn');
        const swipeButtonsContainer = document.getElementById('swipe-buttons-container');
        const skipMatchBtn = document.getElementById('skip-match-btn');
        const likeMatchBtn = document.getElementById('like-match-btn');
        const findMatchesBtnInner = document.getElementById('find-matches-btn-inner'); // Get the inner button

        let currentMatches = [];
        let currentMatchIndex = 0;

        function displayCurrentMatch() {
            if (!roommateMatchCardDisplay || !roommatePrompt || !noMoreMatchesPrompt || !swipeButtonsContainer) return;

            roommateMatchCardDisplay.innerHTML = ''; // Clear current card
            roommatePrompt.classList.add('hidden'); // Ensure prompt is hidden when displaying matches
            noMoreMatchesPrompt.classList.add('hidden'); // Ensure no more matches prompt is hidden

            if (currentMatchIndex < currentMatches.length) {
                const match = currentMatches[currentMatchIndex];
                const matchCard = document.createElement('div');
                matchCard.className = 'roommate-match-card glass-card'; /* Apply glass-card here */
                matchCard.innerHTML = `
                    <img src="${match.avatar_url}" alt="${match.name}" onerror="this.onerror=null;this.src='https://placehold.co/160x160/cccccc/ffffff?text=User'">
                    <h4 class="text-3xl font-bold text-gray-900">${match.name}, ${match.age || 'N/A'}</h4>
                    <p class="text-lg text-gray-600 mb-2">${match.location || 'N/A'}</p>
                    <div class="compatibility-score">${match.compatibility_score || 'N/A'}% Match</div>
                    <p class="text-gray-700 text-sm italic max-w-xs overflow-hidden text-ellipsis whitespace-nowrap">${match.bio || 'No bio provided.'}</p>
                    <button class="match-details-btn btn-secondary mt-4 btn-hover-effect">View Details</button>
                `;
                roommateMatchCardDisplay.appendChild(matchCard);
                swipeButtonsContainer.classList.remove('hidden');

                matchCard.querySelector('.match-details-btn').addEventListener('click', (e) => {
                    const matchData = JSON.parse(e.target.dataset.match);
                    displayActivityDetails('Liked Profile', matchData);
                });

            } else {
                roommateMatchCardDisplay.innerHTML = '';
                swipeButtonsContainer.classList.add('hidden');
                noMoreMatchesPrompt.classList.remove('hidden');
            }
        }

        async function fetchRoommateMatches() {
            if (!roommatePrompt || !noMoreMatchesPrompt || !roommateMatchesLoader || !roommateMatchCardDisplay || !swipeButtonsContainer) return;

            roommatePrompt.classList.add('hidden');
            noMoreMatchesPrompt.classList.add('hidden');
            roommateMatchesLoader.classList.remove('hidden');
            roommateMatchCardDisplay.innerHTML = ''; // Clear any previous cards
            swipeButtonsContainer.classList.add('hidden');

            try {
                const result = await fetch('/api/find_roommate_matches/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({})
                });
                const data = await result.json();

                roommateMatchesLoader.classList.add('hidden');

                if (data.status === 'success' && data.data && data.data.matches) {
                    currentMatches = data.data.matches;
                    currentMatchIndex = 0;
                    if (currentMatches.length > 0) {
                        displayCurrentMatch();
                    } else {
                        noMoreMatchesPrompt.classList.remove('hidden');
                    }
                } else {
                    showToast(data.message || 'Failed to find matches.', 'error');
                    roommatePrompt.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Network error:', error);
                roommateMatchesLoader.classList.add('hidden');
                showToast('Network error. Please try again.', 'error');
                roommatePrompt.classList.remove('hidden');
            }
        }

        async function animateAndAdvance(direction) {
            const currentCard = roommateMatchCardDisplay.querySelector('.roommate-match-card');
            if (currentCard) {
                if (direction === 'like') {
                    const likedMatchData = currentMatches[currentMatchIndex];
                    const dataToSend = {
                        name: likedMatchData.name || '',
                        age: parseInt(likedMatchData.age) || null,
                        gender: likedMatchData.gender || '',
                        location: likedMatchData.location || '',
                        budget: parseInt(likedMatchData.budget) || null,
                        bio: likedMatchData.bio || '',
                        compatibility_score: parseInt(likedMatchData.compatibility_score) || null,
                        avatar_url: likedMatchData.avatar_url || ''
                    };

                    try {
                        const saveResponse = await fetch('/api/save_liked_profile/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify(dataToSend)
                        });
                        const saveResult = await saveResponse.json();
                        if (saveResult.status === 'success') {
                            showToast(saveResult.message, 'success');
                            currentCard.classList.add('swiping-right');
                            currentCard.addEventListener('transitionend', () => {
                                currentMatchIndex++;
                                displayCurrentMatch();
                                window.location.href = '/profile/'; // Explicitly redirect to avoid undefined in URL
                            }, { once: true });
                        } else {
                            showToast(saveResult.message || 'Failed to save liked profile.', 'error');
                            console.error('Error saving liked profile:', saveResult.errors);
                        }
                    } catch (error) {
                        console.error('Network error saving liked profile:', error);
                        showToast('Network error saving liked profile. Please try again.', 'error');
                    }
                } else { // If skipping
                    currentCard.classList.add('swiping-left');
                    currentCard.addEventListener('transitionend', () => {
                        currentMatchIndex++;
                        displayCurrentMatch();
                    }, { once: true });
                }
            }
        }

        if (findMatchesBtn) {
            findMatchesBtn.addEventListener('click', fetchRoommateMatches);
        }

        if (findMatchesBtnInner) { // For the inner button in roommate-prompt
            findMatchesBtnInner.addEventListener('click', fetchRoommateMatches);
        }

        if (resetMatchesBtn) {
            resetMatchesBtn.addEventListener('click', fetchRoommateMatches);
        }

        if (skipMatchBtn) {
            skipMatchBtn.addEventListener('click', () => animateAndAdvance('skip'));
        }

        if (likeMatchBtn) {
            likeMatchBtn.addEventListener('click', () => animateAndAdvance('like'));
        }

        // --- Generic Activity/Service Details Modal Logic ---
        const activityDetailsModal = document.getElementById('activity-details-modal');
        const closeActivityModalBtn = document.getElementById('close-activity-modal-btn');
        const activityModalContent = document.getElementById('activity-modal-content');

        function displayActivityDetails(activityType, details) {
            if (!activityModalContent || !activityDetailsModal) return;

            activityModalContent.innerHTML = '';
            let contentHtml = `<h3 class="text-2xl font-bold text-gray-900 mb-4">${activityType} Details</h3>`;

            if (activityType === 'Liked Profile') {
                contentHtml += `
                    <img src="${details.avatar_url}" alt="${details.name}" class="mx-auto mb-4 w-24 h-24 rounded-full object-cover border-4 border-blue-400" onerror="this.onerror=null;this.src='https://placehold.co/96x96/cccccc/ffffff?text=User'">
                    <h4 class="text-xl font-bold text-gray-900 mb-2">${details.name}, ${details.age || 'N/A'}</h4>
                    <p class="text-md text-gray-700 mb-4">${details.gender || 'N/A'} | ${details.location || 'N/A'}</p>
                    <div class="text-left space-y-3">
                        <div class="detail-item"><i class="fas fa-money-bill-wave"></i><span class="font-semibold">Budget:</span> £${details.budget || 'N/A'} / month</div>
                        <div class="detail-item"><i class="fas fa-user-friends"></i><span class="font-semibold">Compatibility:</span> <span class="compatibility-score-modal">${details.compatibility_score || 'N/A'}%</span></div>
                        <div class="detail-item"><i class="fas fa-info-circle"></i><span class="font-semibold">Bio:</span> ${details.bio || 'No bio provided.'}</div>
                    </div>
                    <!-- <button class="btn-primary mt-6 w-full">Connect with ${details.name}</button> -->
                `;
            } else if (activityType === 'Rent Check') {
                contentHtml += `
                    <div class="text-left space-y-3">
                        <div class="detail-item"><i class="fas fa-map-marker-alt"></i><span class="font-semibold">Postcode:</span> ${details.postcode}</div>
                        <div class="detail-item"><i class="fas fa-bed"></i><span class="font-semibold">Bedrooms:</span> ${details.bedrooms}</div>
                        <div class="detail-item"><i class="fas fa-gbp-sign"></i><span class="font-semibold">Estimated Rent:</span> £${details.estimated_rent} / month</div>
                        <div class="detail-item"><i class="fas fa-calendar-alt"></i><span class="font-semibold">Checked At:</span> ${new Date(details.checked_at).toLocaleString()}</div>
                    </div>
                `;
            } else if (activityType === 'Review') {
                contentHtml += `
                    <div class="text-left space-y-3">
                        <div class="detail-item"><i class="fas fa-user-tie"></i><span class="font-semibold">Landlord:</span> ${details.landlord_name}</div>
                        <div class="detail-item"><i class="fas fa-map-marker-alt"></i><span class="font-semibold">Property:</span> ${details.property_address}</div>
                        <div class="detail-item"><i class="fas fa-star"></i><span class="font-semibold">Rating:</span> ${details.rating} Stars</div>
                        <div class="detail-item"><i class="fas fa-comment-alt"></i><span class="font-semibold">Comments:</span> <p>${details.comments}</p></div>
                        <div class="detail-item"><i class="fas fa-calendar-alt"></i><span class="font-semibold">Reviewed At:</span> ${new Date(details.reviewed_at).toLocaleString()}</div>
                        <div class="detail-item"><i class="fas fa-user"></i><span class="font-semibold">Reviewer:</span> ${details.reviewer}</div>
                    </div>
                `;
            } else if (activityType === 'Complaint') {
                contentHtml += `
                    <div class="text-left space-y-3">
                        <div class="detail-item"><i class="fas fa-exclamation-triangle"></i><span class="font-semibold">Issue Type:</span> ${details.issue_type}</div>
                        <div class="detail-item"><i class="fas fa-map-marker-alt"></i><span class="font-semibold">Property:</span> ${details.property_address}</div>
                        <div class="detail-item"><i class="fas fa-user-tie"></i><span class="font-semibold">Landlord (Optional):</span> ${details.landlord_name || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-file-alt"></i><span class="font-semibold">Description:</span> <p>${details.description}</p></div>
                        <div class="detail-item"><i class="fas fa-info-circle"></i><span class="font-semibold">Status:</span> ${details.status}</div>
                        <div class="detail-item"><i class="fas fa-calendar-alt"></i><span class="font-semibold">Submitted At:</span> ${new Date(details.submitted_at).toLocaleString()}</div>
                    </div>
                `;
            } else if (activityType === 'Forum Post') {
                contentHtml += `
                    <div class="text-left space-y-3">
                        <div class="detail-item"><i class="fas fa-heading"></i><span class="font-semibold">Title:</span> ${details.title}</div>
                        <div class="detail-item"><i class="fas fa-tags"></i><span class="font-semibold">Category:</span> ${details.category}</div>
                        <div class="detail-item"><i class="fas fa-file-alt"></i><span class="font-semibold">Content:</span> <p>${details.content}</p></div>
                        <div class="detail-item"><i class="fas fa-calendar-alt"></i><span class="font-semibold">Posted At:</span> ${new Date(details.created_at).toLocaleString()}</div>
                        <div class="detail-item"><i class="fas fa-user"></i><span class="font-semibold">Author:</span> ${details.author}</div>
                    </div>
                `;
            } else if (activityType === 'Contract Analysis') {
                contentHtml += `
                    <div class="text-left space-y-3">
                        <div class="detail-item"><i class="fas fa-calendar-alt"></i><span class="font-semibold">Analyzed At:</span> ${new Date(details.analyzed_at).toLocaleString()}</div>
                        <div class="detail-item"><i class="fas fa-file-alt"></i><span class="font-semibold">Original Text:</span> <p class="whitespace-pre-wrap text-sm max-h-40 overflow-y-auto border p-2 rounded">${details.original_text}</p></div>
                        <div class="detail-item"><i class="fas fa-robot"></i><span class="font-semibold">AI Analysis:</span> <p class="whitespace-pre-wrap text-sm max-h-60 overflow-y-auto border p-2 rounded">${details.analysis_result}</p></div>
                    </div>
                `;
            } else if (activityType === 'Rent Declaration Check') {
                contentHtml += `
                    <div class="text-left space-y-3">
                        <div class="detail-item"><i class="fas fa-map-marker-alt"></i><span class="font-semibold">Postcode:</span> ${details.postcode}</div>
                        <div class="detail-item"><i class="fas fa-bed"></i><span class="font-semibold">Bedrooms:</span> ${details.bedrooms}</div>
                        <div class="detail-item"><i class="fas fa-pound-sign"></i><span class="font-semibold">Actual Rent Paid:</span> £${details.actual_rent_paid} / month</div>
                        <div class="detail-item"><i class="fas fa-city"></i><span class="font-semibold">Council Tax Band:</span> ${details.council_tax_band}</div>
                        <div class="detail-item"><i class="fas fa-calculator"></i><span class="font-semibold">Estimated Council Tax:</span> £${details.estimated_council_tax || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-exclamation-circle"></i><span class="font-semibold">Discrepancy Found:</span> <span class="${details.discrepancy_found ? 'text-red-600 font-bold' : 'text-green-600 font-bold'}">${details.discrepancy_found ? 'Yes' : 'No'}</span></div>
                        <div class="detail-item"><i class="fas fa-robot"></i><span class="font-semibold">AI Analysis:</span> <p>${details.analysis_result || 'No detailed analysis available.'}</p></div>
                        <div class="detail-item"><i class="fas fa-calendar-alt"></i><span class="font-semibold">Checked At:</span> ${new Date(details.checked_at).toLocaleString()}</div>
                    </div>
                `;
            }
            else {
                contentHtml += `<p class="text-center text-gray-500">Details for this activity type are not available.</p>`;
            }

            activityModalContent.innerHTML = contentHtml;
            activityDetailsModal.classList.remove('hidden');
            activityDetailsModal.classList.add('flex');
        }

        if (closeActivityModalBtn) {
            closeActivityModalBtn.addEventListener('click', () => {
                activityDetailsModal.classList.add('hidden');
                activityDetailsModal.classList.remove('flex');
            });
        }


        // --- Event listener for clicking on Activity/Service items ---
        document.addEventListener('click', (event) => {
            const activityItem = event.target.closest('.activity-item[data-activity-details]');
            const serviceResultCard = event.target.closest('.service-result-card[data-activity-details]');

            if (activityItem) {
                const activityType = activityItem.dataset.activityType;
                const scriptTag = activityItem.querySelector('script[type="application/json"]');
                let details;
                if (scriptTag) {
                    try {
                        details = JSON.parse(scriptTag.textContent);
                    } catch (e) {
                        console.error('Error parsing activity details from script tag:', e);
                        showToast('Error loading activity details.', 'error');
                        return;
                    }
                } else {
                    try {
                        details = JSON.parse(activityItem.dataset.activityDetails);
                    } catch (e) {
                        console.error('Error parsing activity details from data attribute:', e);
                        showToast('Error loading activity details.', 'error');
                        return;
                    }
                }
                displayActivityDetails(activityType, details);
            } else if (serviceResultCard) {
                const activityType = serviceResultCard.dataset.activityType;
                const details = JSON.parse(serviceResultCard.dataset.activityDetails);
                displayActivityDetails(activityType, details);
            }
        });

        // Tab switching logic for My Services section
        document.addEventListener('DOMContentLoaded', () => {
            const mainContentTabButtons = document.querySelectorAll('#my-services-section .main-content-tab-button');
            const mainContentTabContents = document.querySelectorAll('.main-content-tab-content'); // Select all tab content sections

            mainContentTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTabId = button.dataset.tabId;

                    mainContentTabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    mainContentTabContents.forEach(content => {
                        if (content.id === targetTabId) {
                            content.classList.remove('hidden');
                        } else {
                            content.classList.add('hidden');
                        }
                    });
                });
            });
        });
    </script>
    <script src="{% static 'fairrent_app/js/main.js' %}"></script>
</body>
</html>
